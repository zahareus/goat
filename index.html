<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOAT — Pick the Greatest</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="preconnect" href="https://zanssnurnzdqwaxuadge.supabase.co" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css">
<script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#1a1a1a;
  background-image:url("data:image/svg+xml,%3Csvg width='28' height='32' viewBox='0 0 28 32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M14 1 L27 8 L27 24 L14 31 L1 24 L1 8 Z' fill='none' stroke='%23222' stroke-width='1'/%3E%3C/svg%3E");
  color:#f0f0f0;
  font-family:'Arial',sans-serif;
  min-height:100vh;
  user-select:none;
}

/* ===== AUTH MODAL ===== */
.auth-modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);
  align-items:center;justify-content:center;z-index:500;padding:24px;
}
.auth-modal.open{display:flex}
.auth-modal-panel{
  display:flex;flex-direction:column;align-items:center;
  position:relative;max-width:420px;width:100%;
}
.auth-modal-close{position:absolute;top:-8px;right:-8px;color:#666;font-size:24px;cursor:pointer;line-height:1;z-index:10}
.auth-modal-close:hover{color:#fff}
.auth-logo{width:80px;height:80px;margin-bottom:16px}
.auth-sub{font-size:12px;color:#777;letter-spacing:1px;margin-bottom:24px}
.auth-box{
  background:#111;border:1px solid #2a2a2a;padding:28px 24px;
  width:min(380px,100%);
}
.auth-box h2{font-size:14px;font-weight:700;color:#BFB294;letter-spacing:1px;text-transform:uppercase;margin-bottom:16px}
.auth-input{
  width:100%;background:#1a1a1a;border:1px solid #333;color:#fff;
  padding:12px 14px;font-size:14px;margin-bottom:14px;outline:none;
}
.auth-input:focus{border-color:#BFB294}
.auth-btn{
  width:100%;background:#BFB294;color:#111;border:none;
  padding:12px;font-size:13px;font-weight:900;text-transform:uppercase;letter-spacing:1px;
  cursor:pointer;
}
.auth-btn:hover{background:#d4c9a8}
.auth-btn:disabled{opacity:0.5;cursor:not-allowed}
.auth-msg{font-size:12px;color:#777;margin-top:14px;text-align:center;min-height:18px}
.auth-msg.error{color:#ff4444}
.auth-msg.success{color:#4CAF50}

/* ===== NAV ===== */
.app-wrap{}
.nav{
  background:#0d0d0d;border-bottom:1px solid #2a2a2a;
  padding:0 20px;display:flex;align-items:center;justify-content:space-between;
  height:56px;position:sticky;top:0;z-index:200;
}
.nav-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
.nav-logo-img{width:36px;height:36px;object-fit:contain}
.nav-logo-text{font-size:16px;font-weight:900;color:#fff;letter-spacing:3px;text-transform:uppercase}
.nav-center{display:flex;align-items:center;gap:8px}
.gw-nav-arrow{background:none;border:none;color:#666;font-size:18px;cursor:pointer;padding:4px 8px;transition:color .15s}
.gw-nav-arrow:hover{color:#BFB294}
.gw-nav-arrow:disabled{color:#333;cursor:not-allowed}
.gw-nav-label{font-size:14px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase;min-width:60px;text-align:center}
.nav-right{display:flex;align-items:center;gap:12px;position:relative}
.nav-menu-btn{
  display:flex;align-items:center;gap:6px;cursor:pointer;color:#aaa;
  font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  background:none;border:none;padding:6px 0;
}
.nav-menu-btn:hover{color:#fff}
.nav-dropdown{
  display:none;position:absolute;top:44px;right:0;
  background:#111;border:1px solid #2a2a2a;min-width:180px;z-index:300;
}
.nav-dropdown.open{display:block}
.nav-dropdown a{
  display:block;padding:12px 16px;color:#ccc;font-size:12px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.5px;text-decoration:none;
  border-bottom:1px solid #1e1e1e;cursor:pointer;
}
.nav-dropdown a:hover{background:#1a1a1a;color:#BFB294}
.nav-dropdown a:last-child{border-bottom:none}

/* ===== TABS ===== */
.tabs{display:flex;background:#111;border-bottom:1px solid #2a2a2a;position:sticky;top:56px;z-index:190}
.tab{
  flex:1;padding:13px 8px;text-align:center;font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:1px;color:#666;cursor:pointer;
  border-bottom:3px solid transparent;transition:all .2s;
}
.tab.active{color:#BFB294;border-bottom-color:#BFB294}
.tab.locked{color:#444;cursor:not-allowed;pointer-events:none}
.tab.locked .lock-icon{display:inline;font-size:9px;margin-left:2px}
.live-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#ff4444;margin-left:4px;vertical-align:middle;animation:live-pulse 1.5s ease-in-out infinite}
@keyframes live-pulse{0%,100%{opacity:1}50%{opacity:0.2}}
.tab-content{display:none}
.tab-content.active{display:block}

/* ===== PICK TAB ===== */
.gw-header{
  text-align:center;padding:18px 16px 14px;
  background:linear-gradient(180deg,#111 0%,#161616 100%);
  border-bottom:1px solid #2a2a2a;
}
.gw-title{font-size:15px;font-weight:900;color:#fff;letter-spacing:3px;text-transform:uppercase}
.gw-sub{font-size:10px;color:#777;margin-top:4px;letter-spacing:0.5px}

/* Match block */
.match-block{margin-bottom:2px;background:#161616}
.match-header{
  background:#1e1e1e;border-left:3px solid #BFB294;
  padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
}
.match-header-left{display:flex;align-items:center;gap:14px}
.match-num-hex{
  width:34px;height:39px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:900;color:#111;flex-shrink:0;
}
.match-teams-wrap{}
.match-teams{font-size:15px;font-weight:900;color:#fff;letter-spacing:0.5px}
.match-teams span{color:#BFB294;margin:0 8px;font-size:12px}
.match-time{font-size:10px;color:#888;margin-top:2px;letter-spacing:0.3px}
.match-locked{font-size:9px;color:#ff4444;font-weight:700;letter-spacing:0.5px}
.match-selected-badge{
  font-size:10px;background:#BFB294;color:#111;
  padding:3px 10px;font-weight:700;letter-spacing:0.3px;
}

/* Position filter tabs */
.pos-tabs{display:flex;background:#141414;border-bottom:1px solid #222;padding:0 16px}
.pos-tab{
  padding:9px 14px;font-size:10px;font-weight:700;color:#555;
  cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;
  text-transform:uppercase;letter-spacing:0.8px;
}
.pos-tab.active{color:#BFB294;border-bottom-color:#BFB294}
.pos-tab:hover:not(.active){color:#aaa}

/* Horizontal player row */
.player-row-outer{overflow-x:auto;scrollbar-width:none;background:#1a1a1a;padding:16px 0 12px}
.player-row-outer::-webkit-scrollbar{display:none}
.player-row{display:flex;align-items:flex-start;gap:6px;padding:0 16px;min-width:max-content}

/* Individual player card */
.phex-card{
  display:flex;flex-direction:column;align-items:center;gap:5px;
  cursor:pointer;width:82px;transition:transform .15s;
}
.phex-card:hover:not(.selected){transform:translateY(-4px)}
.phex-card:hover:not(.selected) .phex-outer{background:#BFB294}
.phex-card.hidden{display:none!important}
.phex-outer{
  width:76px;height:87px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2e2e2e;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.phex-outer.selected{background:#BFB294}
.phex-inner{
  width:68px;height:78px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.phex-outer.selected .phex-inner{background:#2a2216}
.phex-inner img{width:100%;height:120%;object-fit:cover;object-position:top center;display:block}
.phex-team-pos{font-size:9px;color:#666;text-align:center;line-height:1.5}
.phex-stat{font-size:8px;color:#8a8060;text-align:center;line-height:1.3;white-space:nowrap}
.phex-card.selected .phex-team-pos{color:#BFB294;opacity:0.8}

/* Player name wrap + info button */
.phex-name-wrap{position:relative;display:flex;align-items:center;justify-content:center;gap:2px;width:82px;height:14px}
.phex-name{
  font-size:10px;font-weight:700;color:#ccc;text-align:center;
  white-space:nowrap;max-width:68px;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;transition:color .15s;
}
.phex-name:hover{color:#fff}
.phex-card.selected .phex-name{color:#BFB294}
.phex-info-btn{
  display:none;width:13px;height:13px;border-radius:50%;flex-shrink:0;
  background:#BFB294;color:#0d0d0d;font-size:8px;font-weight:900;font-style:normal;
  align-items:center;justify-content:center;cursor:pointer;line-height:1;transition:background .15s;
}
.phex-info-btn:hover{background:#fff}
.phex-card:hover .phex-info-btn{display:flex}

/* Availability dots + text */
.avail-dot{display:inline-block;width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-right:2px;vertical-align:middle}
.avail-starter{background:#4a8c3f}
.avail-starter_ques{background:#ffc107}
.avail-ques{background:#f08c00}
.avail-out,.avail-sus{background:#e25c3d}
.avail-text{font-size:8px;font-weight:900;margin-right:2px;vertical-align:middle;letter-spacing:0.5px}
.avail-in{color:#4a8c3f}
.avail-out-text{color:#e25c3d}

/* Profile modal overlay */
#mb-profile-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.88);
  display:none;align-items:flex-start;justify-content:center;
  z-index:1000;overflow-y:auto;padding:40px 16px;box-sizing:border-box;
}
.mb-profile-panel{background:#1a1a1a;border:1px solid #BFB294;width:min(520px,100%);border-radius:4px;position:relative;margin:auto}
.mb-profile-close{position:absolute;top:10px;right:14px;color:#666;font-size:24px;cursor:pointer;line-height:1;z-index:10}
.mb-profile-close:hover{color:#fff}
.mb-profile-header{display:flex;align-items:center;gap:20px;padding:24px 24px 20px;border-bottom:1px solid #2e2e2e}
.mb-profile-hex-outer{
  width:90px;height:103px;flex-shrink:0;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
}
.mb-profile-hex-inner{
  width:82px;height:94px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2216;overflow:hidden;
}
.mb-profile-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top center}
.mb-profile-name{font-size:20px;font-weight:700;color:#fff;margin-bottom:6px}
.mb-profile-detail{font-size:12px;color:#888;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.mb-pos-badge{display:inline-block;padding:2px 8px;border-radius:2px;font-size:10px;font-weight:700;color:#0d0d0d;background:#BFB294}
.mb-profile-stats{display:flex;border-bottom:1px solid #2e2e2e}
.mb-stat-block{flex:1;text-align:center;padding:18px 8px;border-right:1px solid #2e2e2e}
.mb-stat-block:last-child{border-right:none}
.mb-stat-val{font-size:24px;font-weight:700;color:#BFB294}
.mb-stat-label{font-size:9px;color:#555;margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.mb-history-title{padding:14px 20px 10px;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #2e2e2e}
.mb-history-wrap{padding:0 0 8px}
.mb-history-table{width:100%;border-collapse:collapse;font-size:11px}
.mb-history-table th{padding:8px 12px;text-align:left;color:#555;font-weight:600;text-transform:uppercase;font-size:9px;letter-spacing:.5px;border-bottom:1px solid #2e2e2e}
.mb-history-table td{padding:7px 12px;border-bottom:1px solid #1e1e1e;color:#bbb}
.mb-history-table tr:last-child td{border-bottom:none}
.mb-history-table tr:hover td{background:#222}
.mb-history-table .td-bps{color:#BFB294;font-weight:700}
.mb-history-table .td-mb{text-align:center;font-size:13px}
.mb-loading{text-align:center;padding:40px;color:#BFB294;font-size:13px}
.mb-api-note{padding:8px 20px 16px;font-size:10px;color:#3a3a3a;font-style:italic}
tr.goat-row{background:#2a2510}
tr.goat-row .td-bps{color:#BFB294;font-weight:900}

/* Team strip (sticky bottom) */
.team-strip{
  position:fixed;bottom:0;left:0;right:0;
  background:#0d0d0d;border-top:2px solid #BFB294;
  padding:8px 16px;display:flex;align-items:center;gap:5px;z-index:300;
}
.strip-label{font-size:9px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-right:4px;white-space:nowrap}
#strip-slots{display:flex;gap:3px;overflow-x:auto;flex:1;align-items:center}
.strip-slot{
  width:28px;height:32px;flex-shrink:0;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#222;overflow:hidden;display:flex;align-items:center;justify-content:center;
}
.strip-slot.filled{background:#BFB294}
.strip-slot img{width:100%;height:120%;object-fit:cover;object-position:top}
.strip-count{font-size:11px;color:#BFB294;font-weight:700;margin-left:2px;white-space:nowrap}
.strip-submit{
  margin-left:auto;background:#BFB294;color:#111;border:none;
  padding:8px 18px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;cursor:pointer;flex-shrink:0;
}
.strip-submit:hover{background:#d4c9a8}
.strip-submit:disabled{opacity:0.5;cursor:not-allowed}
.pick-spacer{height:60px}

/* ===== LIVE TAB ===== */
.live-nav{
  display:flex;overflow-x:auto;background:#111;padding:0 8px;gap:2px;
  border-bottom:1px solid #2a2a2a;scrollbar-width:none;
}
.live-nav::-webkit-scrollbar{display:none}
.live-match-btn{
  flex-shrink:0;padding:10px 14px;font-size:11px;font-weight:700;
  color:#777;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;
}
.live-match-btn.active{color:#BFB294;border-bottom-color:#BFB294}
.live-match-btn .score{color:#fff}
.live-dot{display:inline-block;width:6px;height:6px;background:#ff4444;border-radius:50%;margin-right:4px;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.live-nav-min{color:#ff4444;font-weight:700}
.live-nav-ft{color:#666}
.live-nav-time{color:#888}
.live-header{padding:16px;background:#1a1a1a;border-bottom:1px solid #2a2a2a}
.live-score-row{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px}
.live-team-name{font-size:18px;font-weight:900;color:#fff}
.live-score{font-size:32px;font-weight:900;color:#BFB294}
.live-minute{font-size:12px;color:#ff4444;font-weight:700}
.events-bar{
  display:flex;gap:16px;padding:8px 16px;
  background:#1a1a1a;border-bottom:1px solid #2a2a2a;
  overflow-x:auto;font-size:11px;color:#888;white-space:nowrap;
}
.live-strip-section{background:#1a1a1a;padding-bottom:100px}
.live-strip-wrap{overflow-x:auto;scrollbar-width:none;padding:16px 16px 8px}
.live-strip-wrap::-webkit-scrollbar{display:none}
.live-strip{display:flex;gap:10px;min-width:max-content}
.lv-card{
  width:106px;background:#1e1e1e;border:1px solid #2a2a2a;
  display:flex;flex-direction:column;align-items:center;
  padding:8px 6px 10px;gap:5px;position:relative;transition:transform .15s;
}
.lv-card:hover{transform:translateY(-4px)}
.lv-card:hover .lv-hex-outer{background:#BFB294}
.lv-card.lv-motm{background:#BFB294;border-color:#8a7050}
.lv-card.lv-yours{background:#1e1e1e;border:2px solid #BFB294}
.lv-hex-wrap{position:relative;width:68px;height:78px;margin:2px 0}
.lv-hex-outer{
  width:68px;height:78px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#333;display:flex;align-items:center;justify-content:center;
}
.lv-card.lv-motm .lv-hex-outer{background:#7a6040}
.lv-card.lv-yours .lv-hex-outer{background:#BFB294}
.lv-hex-inner{
  width:61px;height:70px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.lv-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top}
.lv-rank-badge{
  position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);
  width:22px;height:25px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2a2a;display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:900;color:#fff;
}
.lv-card.lv-motm .lv-rank-badge{background:#111;color:#fff}
.lv-card.lv-yours .lv-rank-badge{background:#BFB294;color:#111}
.lv-name{font-size:10px;font-weight:700;color:#ddd;text-align:center;white-space:nowrap;max-width:98px;overflow:hidden;text-overflow:ellipsis;margin-top:4px}
.lv-card.lv-motm .lv-name{color:#111}
.lv-pos{font-size:8px;color:#777;text-transform:uppercase;letter-spacing:0.5px}
.lv-card.lv-motm .lv-pos{color:#4a3820}
.lv-bps{background:#222;width:100%;text-align:center;font-size:15px;font-weight:900;color:#fff;padding:4px 0}
.lv-card.lv-motm .lv-bps{color:#fff;background:#7a6040}
.lv-nav-rank{
  display:inline-flex;width:14px;height:16px;margin-left:3px;vertical-align:middle;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2a2a;align-items:center;justify-content:center;
  font-size:7px;font-weight:900;color:#fff;
}
.lv-nav-rank.lv-rank-motm{background:#BFB294;color:#111}

/* ===== MY TEAM TAB (mt2) ===== */
.mt2-section{padding:20px 0 80px;background:#1a1a1a}
.mt2-title{text-align:center;font-size:12px;font-weight:900;color:#BFB294;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.mt2-subtitle{text-align:center;font-size:10px;color:#666;margin-bottom:16px;letter-spacing:0.3px}
.mt2-scroll-wrap{overflow-x:auto;scrollbar-width:none;padding:0 16px 8px}
.mt2-scroll-wrap::-webkit-scrollbar{display:none}
.mt2-strip{display:flex;gap:10px;min-width:max-content}
.mt2-card{
  width:148px;background:#1e1e1e;border:2px solid #BFB294;
  display:flex;flex-direction:column;align-items:center;
  padding:0 0 10px;gap:0;position:relative;transition:transform .15s;
}
.mt2-card:hover{transform:translateY(-4px)}
.mt2-card:hover .mt2-hex-outer{background:#d4c5a0}
.mt2-card.motm{background:#BFB294;border-color:#8a7050}
.mt2-card.motm:hover .mt2-hex-outer{background:#6a5030}
.mt2-header{width:100%;background:#151515;padding:8px 6px 7px;text-align:center;border-bottom:1px solid #2a2a2a}
.mt2-card.motm .mt2-header{background:#a89570;border-bottom-color:#8a7050}
.mt2-match{font-size:13px;font-weight:900;color:#fff;letter-spacing:1px;text-align:center}
.mt2-card.motm .mt2-match{color:#1a1a1a}
.mt2-status{font-size:11px;font-weight:700;color:#BFB294;letter-spacing:0.5px;margin-top:3px}
.mt2-status.live{color:#ff4444}
.mt2-status.ft{color:#666}
.mt2-card.motm .mt2-status{color:#3a2810}
.mt2-card.motm .mt2-status.live{color:#cc2222}
.mt2-hex-wrap{position:relative;width:82px;height:94px;margin:8px 0 2px}
.mt2-hex-outer{
  width:82px;height:94px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.mt2-card.motm .mt2-hex-outer{background:#7a6040}
.mt2-hex-inner{
  width:74px;height:86px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.mt2-card.motm .mt2-hex-inner{background:#BFB294}
.mt2-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top}
.mt2-rank-badge{
  position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);
  width:24px;height:28px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:900;color:#111;
}
.mt2-card.motm .mt2-rank-badge{background:#111;color:#fff}
.mt2-name{font-size:11px;font-weight:700;color:#ddd;text-align:center;white-space:nowrap;max-width:130px;overflow:hidden;text-overflow:ellipsis;margin-top:5px}
.mt2-card.motm .mt2-name{color:#111}
.mt2-pos{font-size:8px;color:#777;text-transform:uppercase;letter-spacing:0.5px}
.mt2-card.motm .mt2-pos{color:#4a3820}
.mt2-bps{background:#222;width:100%;text-align:center;font-size:15px;font-weight:900;color:#fff;padding:4px 0}
.mt2-bps.pending{background:#1a1a1a;font-size:11px;color:#444;letter-spacing:0.5px}
.mt2-card.motm .mt2-bps{background:#7a6040;color:#fff}

/* ===== LEADERBOARD TAB ===== */
.lb-header{background:#1a1a1a;padding:14px 16px;border-bottom:1px solid #2a2a2a}
.lb-your-pos{
  background:linear-gradient(135deg,#1a1a12 0%,#222215 100%);
  border:1px solid #BFB294;padding:12px 16px;margin:12px 16px;
  display:flex;align-items:center;justify-content:space-between;
}
.lb-your-rank{font-size:32px;font-weight:900;color:#BFB294}
.lb-your-info{font-size:12px;color:#aaa}
.lb-your-info span{color:#fff;font-weight:700}
.lb-table{width:100%;border-collapse:collapse;font-size:12px}
.lb-table th{
  text-align:left;padding:8px 12px;background:#1a1a1a;
  color:#777;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;
  border-bottom:1px solid #2a2a2a;
}
.lb-table td{padding:10px 12px;border-bottom:1px solid #1e1e1e;vertical-align:middle}
.lb-rank{font-weight:900;color:#BFB294;width:36px}
.lb-rank.top3{color:#ffd700}
.lb-name{font-weight:700;color:#ddd;font-size:14px}
.lb-name.me{color:#BFB294}
.lb-name-btn{cursor:pointer}
.lb-name-btn:hover{color:#BFB294;text-decoration:underline;text-decoration-color:#BFB29466}
.lb-motms{color:#BFB294;font-weight:700;text-align:center;width:56px}
.lb-pts{color:#fff;font-weight:700;text-align:right;width:56px}
tr.my-row{background:#1a1a12}
tr.separator td{padding:4px 12px;color:#555;font-size:10px;text-align:center;background:#111}
tr.lb-picks-row{background:#111}
tr.lb-picks-row td{padding:6px 12px 8px}
.lbp-grid{display:grid;grid-template-columns:100px 1fr 36px 40px;column-gap:10px;font-size:11px;line-height:1.6}
.lbp-grid>span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lbp-match{color:#666;font-weight:700}
.lbp-player{color:#ccc;font-weight:700}
.lbp-player.hidden{color:#444;font-weight:400;font-style:italic}
.lbp-rank{color:#BFB294;font-weight:900;text-align:center}
.lbp-bps{color:#888;font-weight:700;text-align:right}

.lb-toggle{display:flex;gap:0;margin:0 16px 0;border:1px solid #333;overflow:hidden}
.lb-toggle-btn{flex:1;padding:8px 0;text-align:center;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#777;background:#111;cursor:pointer;border:none;transition:all .2s}
.lb-toggle-btn.active{background:#BFB294;color:#111}

/* ===== RULES PAGE ===== */
.page-overlay{
  display:none;position:fixed;inset:0;background:#1a1a1a;z-index:400;overflow-y:auto;
}
.page-overlay.open{display:block}
.page-header{
  background:#0d0d0d;border-bottom:1px solid #2a2a2a;
  padding:16px 20px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:10;
}
.page-back{
  background:none;border:1px solid #BFB294;color:#BFB294;
  padding:6px 14px;font-size:11px;font-weight:700;cursor:pointer;text-transform:uppercase;
}
.page-back:hover{background:#BFB294;color:#111}
.page-title{font-size:16px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase}
.page-body{padding:24px 20px;max-width:640px;margin:0 auto}
.page-body h3{color:#BFB294;font-size:14px;font-weight:900;letter-spacing:1px;text-transform:uppercase;margin:24px 0 10px}
.page-body h3:first-child{margin-top:0}
.page-body p{color:#bbb;font-size:13px;line-height:1.7;margin-bottom:12px}
.page-body ul{color:#bbb;font-size:13px;line-height:1.8;padding-left:20px;margin-bottom:12px}
.page-body li{margin-bottom:4px}
.page-body strong{color:#fff}

/* ===== PROFILE PAGE ===== */
.profile-form{max-width:400px;margin:0 auto;padding:32px 20px}
.profile-label{font-size:10px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block}
.profile-input{
  width:100%;background:#1a1a1a;border:1px solid #333;color:#fff;
  padding:12px 14px;font-size:14px;margin-bottom:20px;outline:none;
}
.profile-input:focus{border-color:#BFB294}
.profile-input:disabled{opacity:0.5}
.profile-save{
  background:#BFB294;color:#111;border:none;padding:12px 24px;
  font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:1px;cursor:pointer;
}
.profile-save:hover{background:#d4c9a8}
.profile-msg{font-size:12px;color:#4CAF50;margin-top:10px;min-height:18px}

/* Telegram section */
.tg-section{margin-top:28px;padding-top:24px;border-top:1px solid #2e2e2e}
.tg-section-title{font-size:10px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.tg-desc{font-size:12px;color:#888;margin-bottom:14px;line-height:1.5}
.tg-connect{
  background:#2AABEE;color:#fff;border:none;padding:12px 20px;
  font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;
}
.tg-connect:hover{background:#229ED9}
.tg-connected{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.tg-dot{width:8px;height:8px;border-radius:50%;background:#4CAF50;flex-shrink:0}
.tg-connected-text{font-size:13px;color:#ccc}
.tg-disconnect{
  background:none;border:1px solid #555;color:#888;padding:8px 16px;
  font-size:11px;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;
}
.tg-disconnect:hover{border-color:#ff4444;color:#ff4444}

/* Change button on My Team cards */
.mt2-change{
  margin-top:4px;font-size:10px;color:#BFB294;cursor:pointer;
  border:1px solid #BFB294;padding:3px 10px;text-transform:uppercase;
  letter-spacing:0.5px;font-weight:700;
}
.mt2-change:hover{background:#BFB294;color:#111}
.mt2-actions{display:flex;gap:6px;margin-top:6px}
.mt2-save,.mt2-cancel{
  flex:1;min-width:48px;text-align:center;
  font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;
  padding:4px 6px;cursor:pointer;border:none;color:#fff;
}
.mt2-save{background:#2e7d32}
.mt2-save:hover{background:#388e3c}
.mt2-cancel{background:#c62828}
.mt2-cancel:hover{background:#d32f2f}
.mt2-card.changing{border-color:#fff;box-shadow:0 0 12px rgba(191,178,148,0.3)}

/* My Team change panel */
#mt-change-panel{display:none}
#mt-change-panel.open{display:block;padding:0 0 40px}
.mt-cp-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px 10px;
}
.mt-cp-title{font-size:13px;font-weight:900;color:#BFB294;letter-spacing:1px;text-transform:uppercase}
.mt-cp-close{font-size:20px;color:#666;cursor:pointer;line-height:1;padding:4px 8px}
.mt-cp-close:hover{color:#fff}

/* ===== EMPTY / LOADING STATES ===== */
.empty-state{text-align:center;padding:60px 24px;color:#555}
.empty-state .emoji{font-size:48px;margin-bottom:16px;display:block}
.empty-state h3{color:#888;font-size:14px;font-weight:700;margin-bottom:8px}
.empty-state p{font-size:12px;color:#555;line-height:1.6}
.loading-spinner{text-align:center;padding:60px;color:#BFB294;font-size:13px}

/* ===== TOAST ===== */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  background:#BFB294;color:#111;padding:10px 24px;font-size:12px;font-weight:700;
  letter-spacing:0.5px;z-index:500;opacity:0;transition:opacity .3s;pointer-events:none;
}
.toast.show{opacity:1}

/* ===== MOBILE RESPONSIVE ===== */
@media (max-width: 480px) {
  .nav{padding:0 12px;height:50px}
  .nav-logo-text{font-size:14px;letter-spacing:2px}
  .nav-logo-img{width:30px;height:30px}
  .gw-nav-label{font-size:12px;min-width:50px}
  .tabs .tab{padding:11px 4px;font-size:10px;letter-spacing:0.5px}
  .match-header{padding:8px 12px}
  .match-teams{font-size:13px}
  .match-num-hex{width:28px;height:32px;font-size:11px}
  .player-row{padding:0 10px;gap:4px}
  .phex-card{width:72px}
  .phex-outer{width:66px;height:76px}
  .phex-inner{width:59px;height:68px}
  .phex-name{font-size:9px;max-width:60px}
  .phex-name-wrap{width:72px}
  .lv-card{width:94px;padding:6px 4px 8px}
  .lv-name{font-size:9px;max-width:86px}
  .live-score-row{gap:10px}
  .live-team-name{font-size:14px}
  .live-score{font-size:26px}
  .mt2-card{width:130px}
  .mt2-name{max-width:110px;font-size:10px}
  .team-strip{padding:6px 10px}
  .strip-slot{width:24px;height:28px}
  .strip-submit{padding:6px 14px;font-size:10px}
  .lb-table td{padding:8px 10px}
  .lbp-grid{grid-template-columns:80px 1fr 30px 36px;font-size:10px}
  .lb-your-rank{font-size:26px}
  .mb-profile-header{padding:16px 16px 14px;gap:14px}
  .mb-profile-hex-outer{width:70px;height:80px}
  .mb-profile-hex-inner{width:64px;height:73px}
  .mb-profile-name{font-size:16px}
  .page-body{padding:20px 16px}
}

/* ===== DRIVER.JS TOUR OVERRIDES ===== */
.driver-popover{background:#1a1a1a !important;border:1px solid #BFB294 !important;color:#ccc !important}
.driver-popover-title{color:#BFB294 !important;font-size:14px !important;font-weight:900 !important;letter-spacing:1px !important}
.driver-popover-description{color:#bbb !important;font-size:13px !important;line-height:1.6 !important}
.driver-popover .driver-popover-progress-text{color:#777 !important}
.driver-popover-prev-btn{background:transparent !important;color:#888 !important;border:1px solid #333 !important}
.driver-popover-next-btn,.driver-popover-close-btn-text{background:#BFB294 !important;color:#111 !important;font-weight:700 !important}
.driver-popover-next-btn:hover,.driver-popover-close-btn-text:hover{background:#d4c9a8 !important}
.driver-overlay{background:rgba(0,0,0,0.75) !important}
</style>
</head>
<body>

<!-- ===== AUTH MODAL (overlay, not a blocker) ===== -->
<div id="auth-modal" class="auth-modal" onclick="if(event.target===this)closeAuthModal()">
  <div class="auth-modal-panel">
    <div class="auth-modal-close" onclick="closeAuthModal()">&#x2715;</div>
    <img src="assets/logo.png" class="auth-logo" alt="GOAT">
    <div class="auth-sub">Pick the Greatest of All Time</div>
    <div class="auth-box">
      <h2>Sign in with Email</h2>
      <input type="email" id="auth-email" class="auth-input" placeholder="your@email.com" autocomplete="email">
      <button id="auth-submit" class="auth-btn" onclick="handleAuth()">Send Magic Link</button>
      <div id="auth-msg" class="auth-msg"></div>
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app-wrap" class="app-wrap" style="display:block">

<!-- NAV -->
<div class="nav">
  <div class="nav-logo" onclick="goHome()">
    <img src="assets/logo.png" class="nav-logo-img" alt="">
    <div class="nav-logo-text">GOAT</div>
  </div>
  <div class="nav-center">
    <button class="gw-nav-arrow" id="gw-prev" onclick="changeViewGW(-1)">&larr;</button>
    <span class="gw-nav-label" id="gw-nav-label">GW --</span>
    <button class="gw-nav-arrow" id="gw-next" onclick="changeViewGW(1)">&rarr;</button>
  </div>
  <div class="nav-right">
    <button class="nav-menu-btn" onclick="toggleMenu()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="#aaa"><circle cx="8" cy="8" r="7" stroke="#aaa" stroke-width="1" fill="none"/><circle cx="8" cy="6" r="2.5" fill="#aaa"/><path d="M3 13c0-2.8 2.2-4.5 5-4.5s5 1.7 5 4.5" stroke="#aaa" stroke-width="1" fill="none"/></svg>
      Menu
    </button>
    <div id="nav-dropdown" class="nav-dropdown">
      <a id="menu-profile" onclick="openPage('profile')" style="display:none">Profile</a>
      <a onclick="openPage('rules')">Rules</a>
      <a onclick="shareApp()">Invite Friends</a>
      <a id="menu-signin" onclick="showAuthModal();closeMenu()" style="display:none">Sign In</a>
      <a id="menu-signout" onclick="handleSignOut()" style="display:none">Sign Out</a>
    </div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab" id="tab-btn-pick" onclick="switchTab('pick')">Pick Team</div>
  <div class="tab" id="tab-btn-myteam" onclick="switchTab('myteam')">My Team</div>
  <div class="tab" id="tab-btn-live" onclick="switchTab('live')">Live</div>
  <div class="tab" id="tab-btn-standings" onclick="switchTab('standings')">Standings</div>
</div>

<!-- TAB 1: PICK TEAM -->
<div id="tab-pick" class="tab-content">
  <div class="gw-header">
    <div class="gw-title" id="pick-gw-title">Loading...</div>
    <div class="gw-sub" id="pick-gw-sub"></div>
  </div>
  <div id="pick-matches"><div class="loading-spinner">Loading fixtures...</div></div>
  <div class="pick-spacer"></div>
  <div class="team-strip" id="team-strip">
    <div class="strip-label">Team</div>
    <div id="strip-slots"></div>
    <div class="strip-count" id="strip-count">0/0</div>
    <button class="strip-submit" id="strip-submit" onclick="submitPicks()">Submit</button>
  </div>
</div>

<!-- TAB 2: LIVE -->
<div id="tab-live" class="tab-content">
  <div class="live-nav" id="live-nav"></div>
  <div id="live-match-content">
    <div class="empty-state">
      <span class="emoji">&#x26BD;</span>
      <h3>No live matches</h3>
      <p>Live BPS data will appear here during matchdays</p>
    </div>
  </div>
</div>

<!-- TAB 3: MY TEAM -->
<div id="tab-myteam" class="tab-content">
  <div class="mt2-section">
    <div class="mt2-title" id="mt-title">My GOAT Picks</div>
    <div class="mt2-subtitle" id="mt-subtitle"></div>
    <div class="mt2-scroll-wrap">
      <div class="mt2-strip" id="mt-strip">
        <div class="empty-state" style="min-width:100vw">
          <span class="emoji">&#x1F90C;</span>
          <h3>No picks yet</h3>
          <p>Pick your GOATs on the Pick Team tab</p>
        </div>
      </div>
    </div>
    <div id="mt-change-panel"></div>
  </div>
</div>

<!-- TAB 4: STANDINGS -->
<div id="tab-standings" class="tab-content">
  <div id="standings-content">
    <div class="loading-spinner">Loading standings...</div>
  </div>
</div>

</div><!-- /app-wrap -->

<!-- RULES PAGE -->
<div id="page-rules" class="page-overlay">
  <div class="page-header">
    <button class="page-back" onclick="closePage('rules')">&larr; Back</button>
    <div class="page-title">Rules</div>
  </div>
  <div class="page-body">
    <h3>How to Play</h3>
    <p>GOAT is a fantasy game where you pick the <strong>Greatest Of All Time</strong> (best performer) for each Premier League match in a gameweek. No transfers, no budget — just pure prediction skill.</p>

    <h3>Picking</h3>
    <ul>
      <li>For each match in the gameweek, pick <strong>one player</strong> you think will be the GOAT</li>
      <li>You can pick from <strong>either team</strong> in each match</li>
      <li>Picks lock at <strong>kickoff</strong> of each individual match — not the whole gameweek</li>
      <li>You can change your pick any time before that match kicks off</li>
      <li>Use the <strong>My Team</strong> tab to review and change your picks</li>
      <li>Player stats (avg rank, form, GOAT count) help you make smarter picks</li>
    </ul>

    <h3>What is GOAT?</h3>
    <p>The GOAT of each match is the player with the <strong>highest BPS</strong> (Bonus Points System) at full time. Crowned with a gold card and a crown badge.</p>

    <h3>Scoring</h3>
    <ul>
      <li>If your pick is the GOAT of their match, you earn a <strong>GOAT point</strong></li>
      <li>You also accumulate <strong>BPS</strong> from all your picks across all matches</li>
      <li>Standings are ranked by: <strong>GOATs first</strong>, then total BPS as tiebreaker</li>
    </ul>

    <h3>Standings</h3>
    <ul>
      <li><strong>Gameweek view:</strong> rankings for a single gameweek</li>
      <li><strong>Season view:</strong> cumulative rankings across all gameweeks</li>
      <li>Tap a manager's name to see their individual picks</li>
      <li>Use the GW arrows to browse past and future gameweeks</li>
    </ul>

    <h3>Live Tab</h3>
    <ul>
      <li>Follow BPS leaderboards during live matches (updates every 60 seconds)</li>
      <li>Your pick is highlighted with a gold border</li>
      <li>The current GOAT leader gets a gold card</li>
    </ul>

    <h3>BPS Explained</h3>
    <p>The Bonus Points System is calculated by the official FPL system. It awards points for goals, assists, clean sheets, key passes, tackles, saves, and more. It penalises for yellow/red cards, own goals, missed penalties, and fouls. The player with the highest BPS in each match is the GOAT.</p>

    <h3>Notifications</h3>
    <p>Connect Telegram in your Profile to receive alerts: deadline reminders, lineup announcements, match results, and gameweek summaries.</p>
  </div>
</div>

<!-- PROFILE PAGE -->
<div id="page-profile" class="page-overlay">
  <div class="page-header">
    <button class="page-back" onclick="closePage('profile')">&larr; Back</button>
    <div class="page-title">Profile</div>
  </div>
  <div class="profile-form">
    <label class="profile-label">Email</label>
    <input type="email" class="profile-input" id="profile-email" disabled>
    <label class="profile-label">Team Name</label>
    <input type="text" class="profile-input" id="profile-team-name" maxlength="30" placeholder="My Team">
    <button class="profile-save" onclick="saveProfile()">Save</button>
    <div class="profile-msg" id="profile-msg"></div>

    <!-- Telegram Notifications -->
    <div class="tg-section">
      <div class="tg-section-title">Telegram Notifications</div>
      <div id="tg-not-linked">
        <div class="tg-desc">Get alerts about deadlines, lineups &amp; results.</div>
        <a class="tg-connect" href="https://t.me/goatsoccergame_bot" target="_blank">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.53 8.15l-1.83 8.63c-.13.6-.5.75-.99.47l-2.75-2.03-1.33 1.27c-.15.15-.27.27-.55.27l.2-2.8 5.1-4.6c.22-.2-.05-.3-.34-.12l-6.3 3.97-2.72-.85c-.59-.18-.6-.59.12-.88l10.63-4.1c.5-.18.93.12.77.87z"/></svg>
          Connect Telegram
        </a>
      </div>
      <div id="tg-linked" style="display:none">
        <div class="tg-connected">
          <span class="tg-dot"></span>
          <span class="tg-connected-text">Connected via Telegram</span>
        </div>
        <button class="tg-disconnect" onclick="disconnectTelegram()">Disconnect</button>
      </div>
    </div>
  </div>
</div>

<!-- PLAYER PROFILE MODAL -->
<div id="mb-profile-overlay" onclick="if(event.target===this)closeProfile()">
  <div class="mb-profile-panel">
    <div class="mb-profile-close" onclick="closeProfile()">&#x2715;</div>
    <div id="mb-profile-content"><div class="mb-loading">Loading...</div></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://zanssnurnzdqwaxuadge.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbnNzbnVybnpkcXdheHVhZGdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjQ3MjYsImV4cCI6MjA4NzgwMDcyNn0.KfsLu5SEEjrWNeFxvYl3oanH4_I0LV6RwJxYErs6sQY';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CDN = 'https://zanssnurnzdqwaxuadge.supabase.co/storage/v1/object/public/player-photos/';
const SEASON = '25-26';
const PO = {GKP:1, DEF:2, MID:3, FWD:4};
const POS_COLORS = {GKP:'#f5c518', DEF:'#00d5e0', MID:'#a0e000', FWD:'#ff6b35'};
const FPL_TEAM_MAP = {"1":"ARS","2":"AVL","3":"BUR","4":"BOU","5":"BRE","6":"BHA","7":"CHE","8":"CRY","9":"EVE","10":"FUL","11":"LEE","12":"LIV","13":"MCI","14":"MUN","15":"NEW","16":"NFO","17":"SUN","18":"TOT","19":"WHU","20":"WOL"};

// ===== STATE =====
let currentUser = null;
const FIRST_GW = 28;
let activeGW = null;     // "real" current GW from gw_config
let viewGW = null;       // GW being viewed (nav switcher)
let gwConfigs = {};      // gw -> config cache
let gwLoading = false;   // prevent rapid switching race conditions
let fixtures = [];
let players = {};       // element_id -> player
let results = {};       // fixture_id -> [{element_id, bps, is_goat}]
let userPicks = {};     // fixture_id -> {element_id, id (pick uuid)}
let selections = {};    // fixture_id -> {element_id, code, name, img} (unsaved UI state)
let changingFixtureId = null; // My Team inline change state
let changeOrigElementId = null; // original pick before change
let changeTempElementId = null; // currently previewed pick
let playerStats = {};   // element_id -> {avgRank, formBps, goats}
let statsMaxRound = 0;  // highest GW round in player_history
let maxGW = null;       // highest GW with fixtures in DB
let lineupsData = null; // RotoWire lineup data: { "teamId-teamId": { home, away } }
let standingsMode = 'gw'; // 'gw' or 'season'

// ===== ONBOARDING TOUR =====
function startTour() {
  var driverObj = window.driver.js.driver({
    showProgress: true,
    animate: true,
    allowClose: true,
    overlayColor: 'rgba(0,0,0,0.75)',
    onDestroyStarted: function() {
      localStorage.setItem('goat_tour_done', 'true');
      // Switch back to pick tab if we ended up elsewhere
      var pickTab = document.getElementById('tab-pick');
      if (pickTab && !pickTab.classList.contains('active') && !isViewGWPickLocked()) {
        switchTab('pick');
      }
      driverObj.destroy();
    },
    steps: [
      {
        element: '#pick-gw-title',
        popover: {
          title: 'Welcome to GOAT!',
          description: 'Each gameweek, pick the best player from every match. Let\'s walk through it.',
          side: 'bottom',
          align: 'center'
        }
      },
      {
        element: '#pick-matches .match-block',
        popover: {
          title: 'Match Block',
          description: 'Here\'s a match. Scroll through the players and pick who you think will be the GOAT.',
          side: 'bottom',
          align: 'center'
        }
      },
      {
        element: '#pick-matches .match-block .phex-card',
        popover: {
          title: 'Player Card',
          description: 'Tap a player to select them. Gold border = your pick. Stats shown below: Avg BPS Rank, Form, GOAT count.',
          side: 'bottom',
          align: 'center',
          onNextClick: function() {
            // Require user to click a player card to proceed
            function onCardClick() {
              document.removeEventListener('click', handler);
              driverObj.moveNext();
            }
            function handler(e) {
              if (e.target.closest('.phex-card')) onCardClick();
            }
            document.addEventListener('click', handler);
          }
        }
      },
      {
        element: '#team-strip',
        popover: {
          title: 'Team Strip',
          description: 'Your picks collect here. When you\'ve picked for all matches, hit Submit.',
          side: 'top',
          align: 'center'
        }
      },
      {
        element: '#tab-btn-live',
        popover: {
          title: 'Live Tab',
          description: 'During matches, switch to Live to watch BPS scores update in real-time.',
          side: 'bottom',
          align: 'center',
          onNextClick: function() {
            // Require user to click the Live tab to proceed
            var liveBtn = document.getElementById('tab-btn-live');
            function onClick() {
              liveBtn.removeEventListener('click', onClick);
              switchTab('live');
              setTimeout(function() { driverObj.moveNext(); }, 300);
            }
            liveBtn.addEventListener('click', onClick);
          }
        }
      },
      {
        element: '#tab-btn-standings',
        popover: {
          title: 'Standings',
          description: 'Check Standings to see how you rank. Most GOATs wins, BPS breaks ties. Good luck!',
          side: 'bottom',
          align: 'center'
        }
      }
    ]
  });

  driverObj.drive();
}

function maybeStartTour() {
  if (!currentUser) return;
  if (localStorage.getItem('goat_tour_done') === 'true') return;
  // Force-show pick tab content for tour (even if GW is locked)
  document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.remove('active'); });
  document.querySelectorAll('.tab').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('tab-pick').classList.add('active');
  document.getElementById('tab-btn-pick').classList.add('active');
  var strip = document.getElementById('team-strip');
  if (strip) strip.style.display = '';
  setTimeout(function() {
    // Verify DOM elements exist before starting
    if (document.querySelector('#pick-matches .match-block') && document.querySelector('#pick-matches .phex-card')) {
      startTour();
    }
  }, 500);
}

// ===== AUTH =====
async function initAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
  }

  // Listen for auth changes (magic link callback)
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      closeAuthModal();
      // Reload with user context
      loadAppData().then(function() { maybeStartTour(); });
    }
    if (event === 'SIGNED_OUT') {
      currentUser = null;
      // Reload in guest mode
      loadAppData();
    }
  });

  // Always load the app (guest or authenticated)
  loadAppData().then(function() { maybeStartTour(); });
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const msg = document.getElementById('auth-msg');
  const btn = document.getElementById('auth-submit');
  if (!email) { msg.textContent = 'Enter your email'; msg.className = 'auth-msg error'; return; }

  btn.disabled = true;
  msg.textContent = 'Sending...';
  msg.className = 'auth-msg';

  const { error } = await sb.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.origin }
  });

  btn.disabled = false;
  if (error) {
    msg.textContent = error.message;
    msg.className = 'auth-msg error';
  } else {
    msg.textContent = 'Check your email for the magic link!';
    msg.className = 'auth-msg success';
  }
}

async function handleSignOut() {
  await sb.auth.signOut();
  closeMenu();
}

function showAuthModal() {
  document.getElementById('auth-msg').textContent = '';
  document.getElementById('auth-email').value = '';
  document.getElementById('auth-modal').classList.add('open');
}

function closeAuthModal() {
  document.getElementById('auth-modal').classList.remove('open');
}

// ===== DATA LOADING =====
async function loadAppData() {
  // Update menu for auth state
  updateMenuState();

  // Load GW config (active) + discover max GW available
  const [{ data: gwData }, { data: maxGWData }] = await Promise.all([
    sb.from('gw_config').select('*').eq('is_active', true).limit(1).single(),
    sb.from('fixtures').select('gw').order('gw', { ascending: false }).limit(1).single()
  ]);
  if (gwData) {
    activeGW = gwData.gw;
    viewGW = gwData.gw;
    gwConfigs[gwData.gw] = gwData;
  } else {
    document.getElementById('pick-gw-title').textContent = 'No active gameweek';
    return;
  }
  maxGW = maxGWData ? maxGWData.gw : activeGW;

  // Load players + stats once (they don't change per GW)
  await Promise.all([loadPlayers(), loadPlayerStats(), loadLineups()]);
  if (currentUser) loadProfileData();

  // Check URL hash for initial GW
  const hashGW = parseGWFromHash();
  if (hashGW && hashGW >= FIRST_GW && hashGW <= maxGW) {
    viewGW = hashGW;
  }

  // Load GW-specific data
  await loadGWData(viewGW);
}

function updateMenuState() {
  const isAuth = !!currentUser;
  document.getElementById('menu-profile').style.display = isAuth ? '' : 'none';
  document.getElementById('menu-signout').style.display = isAuth ? '' : 'none';
  document.getElementById('menu-signin').style.display = isAuth ? 'none' : '';
}

// ===== GW NAVIGATION =====
function changeViewGW(delta) {
  const newGW = viewGW + delta;
  if (newGW < FIRST_GW || newGW > (maxGW || activeGW)) return;
  loadGWData(newGW);
}

function updateGWNav() {
  document.getElementById('gw-nav-label').textContent = 'GW ' + viewGW;
  document.getElementById('gw-prev').disabled = (viewGW <= FIRST_GW);
  document.getElementById('gw-next').disabled = (viewGW >= (maxGW || activeGW));
  // Update URL hash
  const newHash = '#gw' + viewGW + '_' + SEASON;
  if (window.location.hash !== newHash) {
    window.location.hash = newHash;
  }
}

function parseGWFromHash() {
  const hash = window.location.hash;
  if (!hash) return null;
  const m = hash.match(/^#gw(\d+)/i);
  if (m) return parseInt(m[1]);
  return null;
}

async function loadGWData(gw) {
  if (gwLoading) return;
  gwLoading = true;
  if (changingFixtureId) mtClosePanel();

  viewGW = gw;
  updateGWNav();
  // Clear ALL stale data from previous GW
  fixtures = [];
  results = {};
  userPicks = {};
  selections = {};

  // Update tab states immediately (gwLoading=true → pick locked)
  updateTabStates();

  // Ensure a tab is visible during loading
  if (!document.querySelector('.tab-content.active')) {
    document.getElementById('tab-live').classList.add('active');
    document.getElementById('tab-btn-live').classList.add('active');
  }

  // Show loading inside each tab's content area (without destroying structure)
  document.getElementById('pick-matches').innerHTML = '<div class="loading-spinner">Loading GW ' + gw + '...</div>';
  document.getElementById('live-match-content').innerHTML = '<div class="loading-spinner">Loading GW ' + gw + '...</div>';
  document.getElementById('live-nav').innerHTML = '';
  document.getElementById('mt-strip').innerHTML = '<div class="loading-spinner" style="min-width:100vw">Loading GW ' + gw + '...</div>';

  try {
    // Cache gw_config if not cached
    if (!gwConfigs[gw]) {
      const { data: cfgArr } = await sb.from('gw_config').select('*').eq('gw', gw).limit(1);
      if (cfgArr && cfgArr.length) gwConfigs[gw] = cfgArr[0];
    }

    // Load fixtures + picks in parallel
    await Promise.all([loadFixtures(), loadUserPicks()]);
    await loadResults();

    // Data loaded — unlock loading guard before tab state check
    gwLoading = false;

    // Render all tabs
    renderPickTab();
    renderLiveTab();
    renderMyTeam();
    loadStandings(viewGW);
    updateTabStates();
    autoSelectTab();
  } catch(e) {
    gwLoading = false;
    throw e;
  }
}

function updateTabStates() {
  const pickBtn = document.getElementById('tab-btn-pick');
  const myteamBtn = document.getElementById('tab-btn-myteam');

  // Pick tab: locked if viewGW pick is locked (for everyone)
  if (isViewGWPickLocked()) {
    pickBtn.classList.add('locked');
    pickBtn.innerHTML = 'Pick Team <span class="lock-icon">&#x1F512;</span>';
  } else {
    pickBtn.classList.remove('locked');
    pickBtn.textContent = 'Pick Team';
  }

  // Live tab: blinking red dot if any match is live in viewed GW
  const liveBtn = document.getElementById('tab-btn-live');
  const hasLive = fixtures.some(f => f.status === 'live');
  if (hasLive) {
    liveBtn.innerHTML = 'Live<span class="live-dot"></span>';
  } else {
    liveBtn.textContent = 'Live';
  }

  // My Team tab: always accessible (has proper empty states)
  myteamBtn.classList.remove('locked');
  myteamBtn.textContent = 'My Team';
}

function isViewGWPickLocked() {
  // During data loading, lock pick to prevent confused state
  if (gwLoading) return true;
  // Past GW: always locked
  if (viewGW < activeGW) return true;
  // Future GW: not locked (browsable, auth required to pick)
  if (viewGW > activeGW) return false;
  // Active GW: locked if any match has started or kickoff passed
  if (!fixtures.length) return false;
  return fixtures.some(f => f.status !== 'scheduled' || new Date() >= new Date(f.kickoff_time));
}

function autoSelectTab() {
  const hasPicks = Object.keys(userPicks).length > 0;
  const locked = isViewGWPickLocked();

  if (!currentUser) {
    // Guest: Live for active/past GW, Pick for future (browsable)
    if (viewGW > activeGW) switchTab('pick');
    else switchTab('live');
  } else if (viewGW < activeGW) {
    // Past GW → Standings
    switchTab('standings');
  } else if (locked && hasPicks) {
    switchTab('myteam');
  } else if (locked && !hasPicks) {
    switchTab('live');
  } else {
    switchTab('pick');
  }
}

function goHome() {
  if (viewGW === activeGW) {
    // Already on active GW, just pick best tab
    autoSelectTab();
  } else {
    loadGWData(activeGW);
  }
}

async function loadFixtures() {
  const { data } = await sb.from('fixtures').select('*').eq('gw', viewGW).order('kickoff_time');
  fixtures = data || [];
}

async function loadPlayers() {
  const { data } = await sb.from('players').select('*');
  players = {};
  (data || []).forEach(p => { players[p.element_id] = p; });
}

async function loadResults() {
  results = {};
  if (!fixtures.length) return;
  const fixtureIds = fixtures.map(f => f.id);
  const { data } = await sb.from('results').select('*').in('fixture_id', fixtureIds).order('bps', { ascending: false });
  results = {};
  (data || []).forEach(r => {
    if (!results[r.fixture_id]) results[r.fixture_id] = [];
    results[r.fixture_id].push(r);
  });
}

async function loadUserPicks() {
  if (!currentUser || !viewGW) {
    userPicks = {};
    selections = {};
    return;
  }
  const { data } = await sb.from('picks').select('*').eq('user_id', currentUser.id).eq('gw', viewGW);
  userPicks = {};
  (data || []).forEach(p => { userPicks[p.fixture_id] = p; });

  // Sync to selections
  selections = {};
  for (const [fid, pick] of Object.entries(userPicks)) {
    const pl = players[pick.element_id];
    if (pl) {
      selections[parseInt(fid)] = {
        element_id: pick.element_id,
        code: pl.code,
        name: pl.short_name || pl.name,
        img: CDN + pl.code + '.png'
      };
    }
  }
}

async function loadPlayerStats() {
  // Fetch bps_rank + bps for all players to compute Bayesian avg rank, form (L6 GWs), GOAT count
  playerStats = {};
  let offset = 0;
  const allRows = [];
  while (true) {
    const { data } = await sb.from('player_history').select('element_id,bps_rank,bps,round,minutes').order('round', { ascending: true }).range(offset, offset + 999);
    if (!data || !data.length) break;
    allRows.push(...data);
    offset += data.length;
    if (data.length < 1000) break;
  }
  // Find max round in data for form window
  statsMaxRound = 0;
  for (const r of allRows) { if (r.round > statsMaxRound) statsMaxRound = r.round; }
  const formStart = Math.max(1, statsMaxRound - 5); // last 6 GWs

  // Bayesian average constants: C=6 prior games, M=15 mean rank
  const C = 6, M = 15;
  const byPlayer = {};   // eid -> [{round, bps_rank, bps}]
  for (const r of allRows) {
    if (!byPlayer[r.element_id]) byPlayer[r.element_id] = [];
    byPlayer[r.element_id].push(r);
  }
  for (const [eid, rows] of Object.entries(byPlayer)) {
    const ranked = rows.filter(r => r.bps_rank);
    const rankSum = ranked.reduce((s, r) => s + r.bps_rank, 0);
    const n = ranked.length;
    const bayesAvg = (C * M + rankSum) / (C + n);
    const goats = ranked.filter(r => r.bps_rank === 1).length;

    // Form: avg BPS over last 6 GWs (missed GWs = 0 BPS)
    const byRound = {};
    for (const r of rows) { byRound[r.round] = r; }
    let formBpsSum = 0;
    for (let gw = formStart; gw <= statsMaxRound; gw++) {
      const r = byRound[gw];
      if (r && r.minutes > 0) formBpsSum += (r.bps || 0);
    }
    const formBps = Math.round(formBpsSum / 6 * 10) / 10;

    playerStats[eid] = {
      avgRank: Math.round(bayesAvg * 10) / 10,
      formBps: formBps,
      goats, games: n
    };
  }
}

// ===== LINEUPS (RotoWire) =====
async function loadLineups() {
  try {
    const resp = await fetch('/api/lineups');
    if (resp.ok) lineupsData = await resp.json();
  } catch(e) { console.warn('Lineups unavailable'); }
}

function getAvailStatus(elementId) {
  if (!lineupsData) return null;
  for (const key of Object.keys(lineupsData)) {
    const m = lineupsData[key];
    for (const side of [m.home, m.away]) {
      if (!side) continue;
      const p = side.find(x => x.fpl_id === elementId);
      if (p) return p.status;
    }
  }
  return null;
}

function availHtml(elementId, fixture) {
  // Confirmed lineups: within 75 min of kickoff or match started
  if (fixture) {
    const ko = new Date(fixture.kickoff_time);
    const minsToKo = (ko - new Date()) / 60000;
    if (fixture.status === 'live' || fixture.status === 'ft' || (minsToKo <= 75 && minsToKo > -15)) {
      const st = getAvailStatus(elementId);
      if (!st) return '';
      if (st === 'starter' || st === 'starter_ques')
        return '<span class="avail-text avail-in">IN</span>';
      return '<span class="avail-text avail-out-text">OUT</span>';
    }
  }
  // Predictions: colored dots
  const st = getAvailStatus(elementId);
  if (!st) return '';
  return '<span class="avail-dot avail-' + st + '"></span>';
}

// ===== DEADLINE HELPERS =====
function getFirstKickoff() {
  // Returns kickoff of first SCHEDULED (not yet started) fixture
  if (!fixtures.length) return null;
  let earliest = null;
  for (const f of fixtures) {
    if (f.status !== 'scheduled') continue;
    const ko = new Date(f.kickoff_time);
    if (!earliest || ko < earliest) earliest = ko;
  }
  return earliest;
}

function hasSubmitted() {
  return Object.keys(userPicks).length > 0;
}

function isMatchLocked(f) {
  const now = new Date();
  const ko = new Date(f.kickoff_time);
  return f.status !== 'scheduled' || now >= ko;
}

// ===== PICK TAB =====
function renderPickTab() {
  const cfg = gwConfigs[viewGW];
  if (!cfg) return;
  document.getElementById('pick-gw-title').textContent = cfg.label || ('Gameweek ' + viewGW);

  // Show deadline = first kickoff time
  const firstKO = getFirstKickoff();
  const now = new Date();
  const submitted = hasSubmitted();
  let subText = '';

  if (!submitted) {
    if (!firstKO) {
      // All matches already started, no scheduled fixtures left
      subText = '\uD83D\uDD12 Deadline passed \u2014 all matches started';
    } else if (now >= firstKO) {
      subText = '\uD83D\uDD12 Deadline passed \u2014 picks are closed';
    } else {
      const koStr = firstKO.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' \u00B7 ' + firstKO.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
      subText = 'Submit before ' + koStr;
    }
  } else {
    subText = 'Submitted \u2713 \u2014 change picks until each match kicks off';
  }
  document.getElementById('pick-gw-sub').textContent = subText;

  renderMatchBlocks();
  renderStrip();
}

function renderMatchBlocks() {
  const container = document.getElementById('pick-matches');
  if (!fixtures.length) {
    container.innerHTML = '<div class="empty-state"><span class="emoji">&#x1F4C5;</span><h3>No fixtures</h3><p>Fixtures will appear when the gameweek is set up</p></div>';
    return;
  }

  const now = new Date();
  const firstKO = getFirstKickoff();
  const submitted = hasSubmitted();
  // Before submit: block if no scheduled fixtures left (global deadline passed)
  const globalDeadlinePassed = !submitted && (!firstKO || now >= firstKO);
  // Lock all matches if viewing past GW
  const notActiveGW = viewGW < activeGW;

  let html = '';
  for (let idx = 0; idx < fixtures.length; idx++) {
    const f = fixtures[idx];
    const matchNum = idx + 1;
    const ko = new Date(f.kickoff_time);
    const matchStarted = isMatchLocked(f);
    // Always lock started matches. Before submit: also lock all if global deadline passed. Lock all for non-active GW.
    const locked = matchStarted || globalDeadlinePassed || notActiveGW;
    const sel = selections[f.id];

    // Get players for this fixture (both teams)
    const matchPlayers = getPlayersForFixture(f);

    const badgeHtml = sel ? '<span class="match-selected-badge">\u2713 ' + sel.name + '</span>' : '';
    const isFt = f.status === 'ft';
    const isLive = f.status === 'live';
    let lockedHtml = '';
    if (isFt) lockedHtml = '<span class="match-locked" style="color:#666">FT ' + f.home_score + '-' + f.away_score + '</span>';
    else if (isLive) lockedHtml = '<span class="match-locked">\u23F1 ' + f.minutes + "\u2019 " + f.home_score + '-' + f.away_score + '</span>';
    else if (locked) lockedHtml = '<span class="match-locked">\uD83D\uDD12 LOCKED</span>';
    const timeStr = ko.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' \u00B7 ' + ko.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

    const cards = matchPlayers.map(function(p, ci) {
      const isSel = sel && sel.element_id === p.element_id;
      const sc = isSel ? ' selected' : '';
      const ps = playerStats[p.element_id] || {};
      const avgR = ps.avgRank || 99;
      const formB = ps.formBps || 0;
      const goats = ps.goats || 0;
      return '<div class="phex-card' + sc + '" data-orig-idx="' + ci + '" data-pos="' + (p.position||'') + '" data-eid="' + p.element_id + '" data-code="' + p.code + '" data-name="' + esc(p.short_name || p.name) + '" data-team="' + (p.team_short||'') + '" data-ph="' + CDN + p.code + '.png" data-avgrank="' + avgR + '" data-form="' + formB + '" data-goats="' + goats + '">'
        + '<div class="phex-name-wrap">'
        + '<div class="phex-name" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">' + availHtml(p.element_id, f) + esc(p.short_name || p.name) + '</div>'
        + '<span class="phex-info-btn" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">i</span>'
        + '</div>'
        + '<div class="phex-outer' + sc + '" onclick="selectPlayer(' + f.id + ',' + p.element_id + ',this.closest(\'.phex-card\'),' + (locked?'true':'false') + ')">'
        + '<div class="phex-inner">'
        + '<img src="' + CDN + p.code + '.png" loading="' + (idx === 0 ? 'eager' : 'lazy') + '" onerror="this.style.display=\'none\'" alt="">'
        + '</div></div>'
        + '<div class="phex-team-pos">' + (p.team_short||'') + ' \u00B7 ' + p.position + '</div>'
        + '</div>';
    }).join('');

    html += '<div class="match-block" id="match-' + f.id + '">'
      + '<div class="match-header">'
      + '<div class="match-header-left">'
      + '<div class="match-num-hex">' + matchNum + '</div>'
      + '<div class="match-teams-wrap">'
      + '<div class="match-teams">' + f.home_short + ' <span>v</span> ' + f.away_short + '</div>'
      + '<div class="match-time">' + timeStr + '</div>'
      + '</div></div>'
      + '<div>' + badgeHtml + lockedHtml + '</div>'
      + '</div>'
      + '<div class="pos-tabs">'
      + '<div class="pos-tab active" onclick="sortMatch(' + f.id + ',\'all\',this)">All</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'avgrank\',this)">Avg Rank</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'form\',this)">Form</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'goats\',this)">\uD83D\uDC51 GOAT</div>'
      + '</div>'
      + '<div class="player-row-outer"><div class="player-row">' + cards + '</div></div>'
      + '</div>';
  }

  container.innerHTML = html;
}

function getPlayersForFixture(f) {
  // Get all players for both teams in this fixture
  const all = Object.values(players).filter(p =>
    p.team_id === f.home_team_id || p.team_id === f.away_team_id
  );
  // Sort: home team first, then by position
  all.sort((a, b) => {
    const aHome = a.team_id === f.home_team_id ? 0 : 1;
    const bHome = b.team_id === f.home_team_id ? 0 : 1;
    if (aHome !== bHome) return aHome - bHome;
    return (PO[a.position]||5) - (PO[b.position]||5);
  });
  return all;
}

function selectPlayer(fixtureId, elementId, cardEl, locked) {
  if (!currentUser) { showAuthModal(); return; }
  if (viewGW < activeGW) { showToast('Cannot pick for past gameweeks'); return; }
  if (locked) { showToast('This match is locked'); return; }

  const matchBlock = document.getElementById('match-' + fixtureId);
  const currentSel = selections[fixtureId];
  const isDeselect = currentSel && currentSel.element_id === elementId;

  // Deselect all in this match
  matchBlock.querySelectorAll('.phex-card').forEach(c => {
    c.classList.remove('selected');
    c.querySelector('.phex-outer').classList.remove('selected');
  });

  const badge = matchBlock.querySelector('.match-header > div:last-child');

  if (isDeselect) {
    // Toggle off — clear selection
    delete selections[fixtureId];
    badge.innerHTML = '';
    renderStrip();

    // If already submitted, delete the pick from DB
    if (hasSubmitted() && userPicks[fixtureId]) {
      deleteSinglePick(fixtureId);
    }
    return;
  }

  // Select this card
  cardEl.classList.add('selected');
  cardEl.querySelector('.phex-outer').classList.add('selected');

  const name = cardEl.dataset.name;
  const code = parseInt(cardEl.dataset.code);
  const img = cardEl.dataset.ph;

  badge.innerHTML = '<span class="match-selected-badge">\u2713 ' + name + '</span>';

  selections[fixtureId] = { element_id: elementId, code, name, img };
  renderStrip();

  // Auto-save if user already submitted picks (Phase 2)
  if (hasSubmitted()) {
    saveSinglePick(fixtureId, elementId);
  }
}

async function saveSinglePick(fixtureId, elementId) {
  if (!currentUser || viewGW < activeGW) return;
  const existing = userPicks[fixtureId];
  try {
    if (existing) {
      if (existing.element_id === elementId) return; // no change
      await sb.from('picks').update({
        element_id: elementId,
        updated_at: new Date().toISOString()
      }).eq('id', existing.id);
    } else {
      await sb.from('picks').insert({
        user_id: currentUser.id,
        fixture_id: fixtureId,
        element_id: elementId,
        gw: viewGW
      });
    }
    // Update local state
    await loadUserPicks();
    showToast('Pick saved');
  } catch(e) {
    showToast('Error saving pick');
    console.error(e);
  }
}

async function deleteSinglePick(fixtureId) {
  if (!currentUser || viewGW < activeGW) return;
  const existing = userPicks[fixtureId];
  if (!existing) return;
  try {
    await sb.from('picks').delete().eq('id', existing.id);
    await loadUserPicks();
    showToast('Pick removed');
  } catch(e) {
    showToast('Error removing pick');
    console.error(e);
  }
}

function renderStrip() {
  const slotsEl = document.getElementById('strip-slots');
  const submitBtn = document.getElementById('strip-submit');
  const totalMatches = fixtures.length;
  let html = '';
  let count = 0;

  for (let i = 0; i < totalMatches; i++) {
    const fid = fixtures[i].id;
    const sel = selections[fid];
    if (sel) {
      count++;
      html += '<div class="strip-slot filled"><img src="' + sel.img + '" onerror="this.style.display=\'none\'" alt=""></div>';
    } else {
      html += '<div class="strip-slot"></div>';
    }
  }

  slotsEl.innerHTML = html;
  document.getElementById('strip-count').textContent = count + '/' + totalMatches;

  const submitted = hasSubmitted();
  const now = new Date();
  const firstKO = getFirstKickoff();
  const globalDeadlinePassed = !submitted && firstKO && now >= firstKO;

  if (submitted) {
    // Phase 2: auto-save mode, hide submit button
    submitBtn.style.display = 'none';
  } else if (globalDeadlinePassed) {
    submitBtn.textContent = 'Closed';
    submitBtn.disabled = true;
    submitBtn.style.display = '';
  } else if (count < totalMatches) {
    submitBtn.style.display = '';
    submitBtn.textContent = count === 0 ? 'Pick GOATs' : count + '/' + totalMatches + ' — pick all';
    submitBtn.disabled = true;
  } else {
    submitBtn.style.display = '';
    submitBtn.textContent = 'Submit';
    submitBtn.disabled = false;
  }
}

async function submitPicks() {
  if (!currentUser || viewGW < activeGW) return;
  const btn = document.getElementById('strip-submit');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    for (const [fixtureId, sel] of Object.entries(selections)) {
      const fid = parseInt(fixtureId);
      const f = fixtures.find(x => x.id === fid);
      if (!f) continue;

      // Skip locked matches
      const now = new Date();
      const ko = new Date(f.kickoff_time);
      if (f.status !== 'scheduled' || now >= ko) continue;

      const existing = userPicks[fid];
      if (existing) {
        // Update existing pick
        if (existing.element_id !== sel.element_id) {
          await sb.from('picks').update({
            element_id: sel.element_id,
            updated_at: new Date().toISOString()
          }).eq('id', existing.id);
        }
      } else {
        // Insert new pick
        await sb.from('picks').insert({
          user_id: currentUser.id,
          fixture_id: fid,
          element_id: sel.element_id,
          gw: viewGW
        });
      }
    }

    // Reload picks
    await loadUserPicks();
    showToast('Picks saved!');
    // Re-render to switch to Phase 2 (auto-save mode)
    renderPickTab();
    renderMyTeam();
  } catch(e) {
    showToast('Error saving picks');
    console.error(e);
  }

  btn.disabled = false;
  btn.textContent = 'Submit';
}

function sortMatch(fixtureId, mode, tabEl, useRawId) {
  const matchBlock = document.getElementById(useRawId ? fixtureId : 'match-' + fixtureId);
  matchBlock.querySelectorAll('.pos-tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');
  const row = matchBlock.querySelector('.player-row');
  const cards = Array.from(row.querySelectorAll('.phex-card'));
  cards.forEach(c => c.classList.remove('hidden'));
  if (mode === 'all') {
    // Default: home team first, then by position
    cards.sort((a, b) => {
      const aIdx = parseInt(a.dataset.origIdx || '0');
      const bIdx = parseInt(b.dataset.origIdx || '0');
      return aIdx - bIdx;
    });
  } else if (mode === 'avgrank') {
    cards.sort((a, b) => parseFloat(a.dataset.avgrank) - parseFloat(b.dataset.avgrank));
  } else if (mode === 'form') {
    cards.sort((a, b) => parseFloat(b.dataset.form) - parseFloat(a.dataset.form));
  } else if (mode === 'goats') {
    cards.sort((a, b) => parseInt(b.dataset.goats) - parseInt(a.dataset.goats));
  }
  cards.forEach(c => row.appendChild(c));
}

// ===== LIVE TAB =====
async function renderLiveTab() {
  await Promise.all([loadFixtures(), loadResults()]);

  const nav = document.getElementById('live-nav');
  const content = document.getElementById('live-match-content');

  if (!fixtures.length) {
    nav.innerHTML = '';
    content.innerHTML = '<div class="empty-state"><span class="emoji">&#x26BD;</span><h3>No fixtures for GW' + viewGW + '</h3><p>Fixtures will appear when the gameweek is set up</p></div>';
    return;
  }

  // Build nav buttons
  let navHtml = '';
  let firstLive = null;
  let lastFt = null;
  for (const f of fixtures) {
    const isLive = f.status === 'live';
    const isFt = f.status === 'ft';
    const dotHtml = isLive ? '<span class="live-dot"></span>' : '';
    const statusHtml = isLive ? '<span class="live-nav-min">' + f.minutes + "'" + '</span>'
      : isFt ? '<span class="live-nav-ft">FT</span>'
      : '<span class="live-nav-time">' + new Date(f.kickoff_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) + '</span>';

    const scoreHtml = (isLive || isFt) ? ' <span class="score">' + f.home_score + '\u2013' + f.away_score + '</span> ' : ' ';

    // Get user's pick rank in this match
    const myPick = userPicks[f.id];
    const matchResults = results[f.id] || [];
    let rankHtml = '';
    if (myPick && matchResults.length) {
      const idx = matchResults.findIndex(r => r.element_id === myPick.element_id);
      const rank = idx >= 0 ? idx + 1 : '–';
      const isGoat = idx === 0 && matchResults[0].is_goat;
      rankHtml = '<span class="lv-nav-rank' + (isGoat ? ' lv-rank-motm' : '') + '">' + rank + '</span>';
    }

    // Track first live and last FT
    if (isLive && !firstLive) firstLive = f.id;
    if (isFt) lastFt = f.id;

    navHtml += '<div class="live-match-btn" data-fid="' + f.id + '" onclick="showLiveMatch(' + f.id + ',this)">' + dotHtml + f.home_short + ' - ' + f.away_short + scoreHtml + statusHtml + rankHtml + '</div>';
  }

  // Smart match selection: first live → last FT → first fixture
  let firstActive = firstLive || lastFt || (fixtures.length ? fixtures[0].id : null);
  if (!firstActive) return;

  nav.innerHTML = navHtml;
  // Ensure first active button is marked
  if (!nav.querySelector('.live-match-btn.active')) {
    var firstBtn = nav.querySelector('.live-match-btn[data-fid="' + firstActive + '"]');
    if (firstBtn) firstBtn.classList.add('active');
  }

  showLiveMatchContent(firstActive);
}

function showLiveMatch(fixtureId, btnEl) {
  document.querySelectorAll('.live-match-btn').forEach(b => b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  showLiveMatchContent(fixtureId);
}

function showLiveMatchContent(fixtureId) {
  const content = document.getElementById('live-match-content');
  const f = fixtures.find(x => x.id === fixtureId);
  if (!f) return;

  const matchResults = results[fixtureId] || [];
  const isLive = f.status === 'live';
  const isFt = f.status === 'ft';
  const myPick = userPicks[fixtureId];

  // Header
  let html = '<div class="live-header">';
  html += '<div class="live-score-row">';
  html += '<div class="live-team-name">' + f.home_short + '</div>';
  if (isLive || isFt) {
    html += '<div class="live-score">' + f.home_score + ' \u2013 ' + f.away_score + '</div>';
  } else {
    html += '<div class="live-score">\u2013</div>';
  }
  html += '<div class="live-team-name">' + f.away_short + '</div>';
  html += '</div>';
  if (isLive) html += '<div style="text-align:center"><span class="live-minute">\u23F1 ' + f.minutes + "'" + '</span></div>';
  if (isFt) html += '<div style="text-align:center"><span style="color:#666;font-size:12px;font-weight:700">FULL TIME</span></div>';
  html += '</div>';

  // Player cards
  if (matchResults.length) {
    html += '<div class="live-strip-section"><div class="live-strip-wrap"><div class="live-strip">';
    matchResults.forEach((r, idx) => {
      const pl = players[r.element_id];
      if (!pl) return;
      const rank = idx + 1;
      const isGoat = r.is_goat;
      const isYours = myPick && myPick.element_id === r.element_id;
      let cls = 'lv-card';
      if (isGoat) cls += ' lv-motm';
      else if (isYours) cls += ' lv-yours';

      html += '<div class="' + cls + '">'
        + '<div class="lv-hex-wrap">'
        + '<div class="lv-hex-outer"><div class="lv-hex-inner"><img src="' + CDN + pl.code + '.png" onerror="this.style.display=\'none\'" alt=""></div></div>'
        + '<div class="lv-rank-badge">' + rank + '</div>'
        + '</div>'
        + '<div class="lv-name">' + esc(pl.short_name || pl.name) + '</div>'
        + '<div class="lv-pos">' + pl.position + '</div>'
        + '<div class="lv-bps">' + r.bps + '</div>'
        + '</div>';
    });
    html += '</div></div></div>';
  } else {
    html += '<div class="empty-state"><span class="emoji">&#x1F4CA;</span><h3>No BPS data yet</h3><p>BPS will update during the match</p></div>';
  }

  content.innerHTML = html;
}

// ===== MY TEAM TAB =====
// ===== MY TEAM — INLINE CHANGE =====
function openChangePanel(fixtureId) {
  // Close any existing panel first
  if (changingFixtureId) mtClosePanel();

  const f = fixtures.find(x => x.id === fixtureId);
  if (!f) return;
  const pick = userPicks[fixtureId];
  if (!pick) return;

  changingFixtureId = fixtureId;
  changeOrigElementId = pick.element_id;
  changeTempElementId = pick.element_id;

  // Re-render cards to show Save/Cancel on the active card
  renderMyTeam();

  // Render the match block (same as Pick tab)
  const panel = document.getElementById('mt-change-panel');
  const matchPlayers = getPlayersForFixture(f);

  const cards = matchPlayers.map(function(p, ci) {
    const isSel = p.element_id === changeTempElementId;
    const sc = isSel ? ' selected' : '';
    const ps = playerStats[p.element_id] || {};
    const avgR = ps.avgRank || 99;
    const formB = ps.formBps || 0;
    const goats = ps.goats || 0;
    return '<div class="phex-card' + sc + '" data-orig-idx="' + ci + '" data-pos="' + (p.position||'') + '" data-eid="' + p.element_id + '" data-code="' + p.code + '" data-name="' + esc(p.short_name || p.name) + '" data-team="' + (p.team_short||'') + '" data-ph="' + CDN + p.code + '.png" data-avgrank="' + avgR + '" data-form="' + formB + '" data-goats="' + goats + '">'
      + '<div class="phex-name-wrap">'
      + '<div class="phex-name" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">' + availHtml(p.element_id, f) + esc(p.short_name || p.name) + '</div>'
      + '<span class="phex-info-btn" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">i</span>'
      + '</div>'
      + '<div class="phex-outer' + sc + '" onclick="mtSelectPlayer(' + fixtureId + ',' + p.element_id + ',this.closest(\'.phex-card\'))">'
      + '<div class="phex-inner">'
      + '<img src="' + CDN + p.code + '.png" loading="lazy" onerror="this.style.display=\'none\'" alt="">'
      + '</div></div>'
      + '<div class="phex-team-pos">' + (p.team_short||'') + ' \u00B7 ' + p.position + '</div>'
      + '</div>';
  }).join('');

  const ko = new Date(f.kickoff_time);
  const timeStr = ko.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' \u00B7 ' + ko.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

  panel.innerHTML = '<div class="mt-cp-header">'
    + '<div class="mt-cp-title">' + f.home_short + ' v ' + f.away_short + ' \u00B7 ' + timeStr + '</div>'
    + '<div class="mt-cp-close" onclick="mtCancelChange()">&#x2715;</div>'
    + '</div>'
    + '<div class="match-block" id="mt-match-' + fixtureId + '">'
    + '<div class="pos-tabs">'
    + '<div class="pos-tab active" onclick="sortMatch(\'mt-match-' + fixtureId + '\',\'all\',this,true)">All</div>'
    + '<div class="pos-tab" onclick="sortMatch(\'mt-match-' + fixtureId + '\',\'avgrank\',this,true)">Avg Rank</div>'
    + '<div class="pos-tab" onclick="sortMatch(\'mt-match-' + fixtureId + '\',\'form\',this,true)">Form</div>'
    + '<div class="pos-tab" onclick="sortMatch(\'mt-match-' + fixtureId + '\',\'goats\',this,true)">\uD83D\uDC51 GOAT</div>'
    + '</div>'
    + '<div class="player-row-outer"><div class="player-row">' + cards + '</div></div>'
    + '</div>';

  panel.classList.add('open');

  // Scroll panel into view
  setTimeout(function() { panel.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
}

function mtSelectPlayer(fixtureId, elementId, cardEl) {
  if (fixtureId !== changingFixtureId) return;

  // Deselect all in change panel
  const panel = document.getElementById('mt-match-' + fixtureId);
  panel.querySelectorAll('.phex-card').forEach(c => {
    c.classList.remove('selected');
    c.querySelector('.phex-outer').classList.remove('selected');
  });

  // Select this card
  cardEl.classList.add('selected');
  cardEl.querySelector('.phex-outer').classList.add('selected');

  changeTempElementId = elementId;

  // Update the mt2-card preview
  const pl = players[elementId];
  if (pl) {
    const img = document.getElementById('mt-img-' + fixtureId);
    if (img) { img.src = CDN + pl.code + '.png'; img.style.display = ''; }
    const nameEl = document.getElementById('mt-name-' + fixtureId);
    if (nameEl) nameEl.textContent = pl.short_name || pl.name;
    const posEl = document.getElementById('mt-pos-' + fixtureId);
    if (posEl) posEl.textContent = pl.position;
  }
}

async function mtSaveChange() {
  if (!changingFixtureId || !changeTempElementId) return;
  if (changeTempElementId !== changeOrigElementId) {
    await saveSinglePick(changingFixtureId, changeTempElementId);
  }
  mtClosePanel();
  renderMyTeam();
}

function mtCancelChange() {
  if (!changingFixtureId) return;
  // Revert card preview to original
  if (changeOrigElementId) {
    const pl = players[changeOrigElementId];
    if (pl) {
      const img = document.getElementById('mt-img-' + changingFixtureId);
      if (img) { img.src = CDN + pl.code + '.png'; img.style.display = ''; }
      const nameEl = document.getElementById('mt-name-' + changingFixtureId);
      if (nameEl) nameEl.textContent = pl.short_name || pl.name;
      const posEl = document.getElementById('mt-pos-' + changingFixtureId);
      if (posEl) posEl.textContent = pl.position;
    }
  }
  mtClosePanel();
  renderMyTeam();
}

function mtClosePanel() {
  changingFixtureId = null;
  changeOrigElementId = null;
  changeTempElementId = null;
  const panel = document.getElementById('mt-change-panel');
  panel.classList.remove('open');
  panel.innerHTML = '';
}

function renderMyTeam() {
  const strip = document.getElementById('mt-strip');
  const cfg = gwConfigs[viewGW];
  document.getElementById('mt-subtitle').textContent = cfg ? (cfg.label || 'Gameweek ' + viewGW) : '';

  if (!Object.keys(userPicks).length) {
    if (!currentUser) {
      strip.innerHTML = '<div class="empty-state" style="min-width:100vw"><span class="emoji">&#x1F512;</span><h3>Sign in to play</h3><p>Create an account to pick your GOATs and track your results</p><div style="margin-top:16px"><button onclick="showAuthModal()" style="background:#BFB294;color:#111;border:none;padding:10px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;cursor:pointer">Sign In</button></div></div>';
    } else {
      strip.innerHTML = '<div class="empty-state" style="min-width:100vw"><span class="emoji">&#x1F90C;</span><h3>No picks yet for GW' + viewGW + '</h3><p>Head to the Pick Team tab to choose your GOATs</p><div style="margin-top:16px"><button onclick="switchTab(\'pick\')" style="background:#BFB294;color:#111;border:none;padding:10px 24px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;cursor:pointer">Pick Team</button></div></div>';
    }
    return;
  }

  let html = '';
  for (const f of fixtures) {
    const pick = userPicks[f.id];
    if (!pick) continue;
    const pl = players[pick.element_id];
    if (!pl) continue;

    const isLive = f.status === 'live';
    const isFt = f.status === 'ft';
    const matchResults = results[f.id] || [];

    // Find rank (results are pre-sorted by bps desc)
    let rank = '–';
    let bpsVal = '–';
    let isGoat = false;
    if (matchResults.length) {
      const sorted = [...matchResults].sort((a, b) => b.bps - a.bps);
      const idx = sorted.findIndex(r => r.element_id === pick.element_id);
      if (idx >= 0) {
        rank = idx + 1;
        bpsVal = sorted[idx].bps;
        isGoat = sorted[idx].is_goat;
      }
    }

    const cardClass = isGoat ? ' motm' : '';
    let statusClass = '';
    let statusText = '';
    if (isFt) {
      statusClass = ' ft';
      statusText = 'FT ' + f.home_score + '-' + f.away_score;
    } else if (isLive) {
      statusClass = ' live';
      statusText = f.minutes + "' " + f.home_score + '-' + f.away_score;
    } else {
      const ko = new Date(f.kickoff_time);
      statusText = ko.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) + ' · ' + ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }

    const bpsClass = (!isLive && !isFt) ? ' pending' : '';
    const bpsDisplay = (!isLive && !isFt) ? '\u2013' : bpsVal;
    const canChange = !isMatchLocked(f);
    const isChanging = changingFixtureId === f.id;
    let actionHtml = '';
    if (isChanging) {
      actionHtml = '<div class="mt2-actions">'
        + '<div class="mt2-save" onclick="mtSaveChange()">Save</div>'
        + '<div class="mt2-cancel" onclick="mtCancelChange()">Cancel</div>'
        + '</div>';
    } else if (canChange) {
      actionHtml = '<div class="mt2-change" onclick="openChangePanel(' + f.id + ')">Change</div>';
    }
    const changingClass = isChanging ? ' changing' : '';

    html += '<div class="mt2-card' + cardClass + changingClass + '" id="mt-card-' + f.id + '">'
      + '<div class="mt2-header">'
      + '<div class="mt2-match">' + f.home_short + ' v ' + f.away_short + '</div>'
      + '<div class="mt2-status' + statusClass + '">' + statusText + '</div>'
      + '</div>'
      + '<div class="mt2-hex-wrap">'
      + '<div class="mt2-hex-outer"><div class="mt2-hex-inner"><img id="mt-img-' + f.id + '" src="' + CDN + pl.code + '.png" onerror="this.style.display=\'none\'" alt=""></div></div>'
      + '<div class="mt2-rank-badge">' + rank + '</div>'
      + '</div>'
      + '<div class="mt2-name" id="mt-name-' + f.id + '">' + availHtml(pl.element_id, f) + esc(pl.short_name || pl.name) + '</div>'
      + '<div class="mt2-pos" id="mt-pos-' + f.id + '">' + pl.position + '</div>'
      + '<div class="mt2-bps' + bpsClass + '">' + bpsDisplay + '</div>'
      + actionHtml
      + '</div>';
  }

  strip.innerHTML = html || '<div class="empty-state" style="min-width:100vw"><span class="emoji">&#x1F90C;</span><h3>No picks yet</h3></div>';
}

// ===== STANDINGS TAB =====
async function loadStandings(gw) {
  const content = document.getElementById('standings-content');
  if (standingsMode === 'season') {
    await loadSeasonStandings(content);
  } else {
    await loadGWStandings(gw, content);
  }
}

function switchStandings(mode) {
  standingsMode = mode;
  loadStandings(viewGW);
}

async function loadGWStandings(gw, content) {

  content.innerHTML = '<div class="loading-spinner">Loading standings...</div>';

  // Get all picks for this GW
  const { data: allPicks } = await sb.from('picks').select('*').eq('gw', gw);
  if (!allPicks || !allPicks.length) {
    content.innerHTML = buildStandingsToggle() + '<div class="empty-state"><span class="emoji">&#x1F3C6;</span><h3>No standings yet</h3><p>Standings appear after picks are submitted</p></div>';
    return;
  }

  // Get results for GW fixtures
  const { data: gwFixtures } = await sb.from('fixtures').select('*').eq('gw', gw);
  const fIds = (gwFixtures || []).map(f => f.id);
  const { data: gwResults } = await sb.from('results').select('*').in('fixture_id', fIds);

  // Build results lookup
  const resMap = {};
  (gwResults || []).forEach(r => {
    if (!resMap[r.fixture_id]) resMap[r.fixture_id] = {};
    resMap[r.fixture_id][r.element_id] = r;
  });

  // Calculate scores per user
  const userScores = {};
  allPicks.forEach(pick => {
    if (!userScores[pick.user_id]) userScores[pick.user_id] = { goats: 0, bps: 0, picks: [] };
    const r = resMap[pick.fixture_id] && resMap[pick.fixture_id][pick.element_id];
    const bps = r ? r.bps : 0;
    const isGoat = r ? r.is_goat : false;
    // Calculate rank from sorted results for this fixture
    let pickRank = 0;
    if (resMap[pick.fixture_id]) {
      const fResults = Object.values(resMap[pick.fixture_id]).sort((a, b) => b.bps - a.bps);
      const rIdx = fResults.findIndex(x => x.element_id === pick.element_id);
      if (rIdx >= 0) pickRank = rIdx + 1;
    }
    userScores[pick.user_id].bps += bps;
    if (isGoat) userScores[pick.user_id].goats++;
    userScores[pick.user_id].picks.push({ fixture_id: pick.fixture_id, element_id: pick.element_id, bps, isGoat, rank: pickRank });
  });

  // Get profiles
  const userIds = Object.keys(userScores);
  const { data: profiles } = await sb.from('profiles').select('*').in('id', userIds);
  const profileMap = {};
  (profiles || []).forEach(p => { profileMap[p.id] = p; });

  // Sort: GOATs desc, BPS desc
  const sorted = userIds.map(uid => ({
    uid,
    name: profileMap[uid] ? profileMap[uid].team_name : 'Unknown',
    goats: userScores[uid].goats,
    bps: userScores[uid].bps,
    picks: userScores[uid].picks
  })).sort((a, b) => b.goats - a.goats || b.bps - a.bps);

  // Find my position
  const myIdx = sorted.findIndex(s => s.uid === (currentUser ? currentUser.id : null));
  const myRank = myIdx >= 0 ? myIdx + 1 : '\u2013';
  const myEntry = myIdx >= 0 ? sorted[myIdx] : null;

  // Build HTML
  let html = buildStandingsToggle();
  html += '<div class="lb-header">';
  html += '<div style="font-size:14px;font-weight:900;color:#fff">LEADERBOARD \u2014 GW' + gw + '</div>';
  html += '<div style="font-size:11px;color:#777;margin-top:4px">Ranked by: GOATs \u00B7 tiebreak: Total BPS &nbsp;\u00B7&nbsp; <span style="color:#BFB294;font-weight:700">' + sorted.length + ' managers</span></div>';
  html += '</div>';

  if (myEntry) {
    html += '<div class="lb-your-pos"><div>';
    html += '<div style="font-size:11px;color:#777;margin-bottom:2px">YOUR POSITION</div>';
    html += '<div class="lb-your-rank">#' + myRank + '</div>';
    html += '</div><div class="lb-your-info">' + esc(myEntry.name) + '<br><span>' + myEntry.goats + ' GOATs</span> \u00B7 <span>' + myEntry.bps.toLocaleString() + ' BPS</span></div></div>';
  }

  html += '<table class="lb-table"><thead><tr><th>#</th><th>Player</th><th style="text-align:center">GOATs</th><th style="text-align:right">BPS</th></tr></thead><tbody>';

  // Show top 20 + separator + my row
  const showCount = Math.min(20, sorted.length);
  for (let i = 0; i < showCount; i++) {
    const s = sorted[i];
    const rank = i + 1;
    const isMe = s.uid === (currentUser ? currentUser.id : null);
    const rankCls = rank <= 3 ? ' top3' : '';
    const nameCls = isMe ? ' me' : '';
    const rowCls = isMe ? ' class="my-row"' : '';
    html += '<tr' + rowCls + '><td class="lb-rank' + rankCls + '">' + rank + '</td><td class="lb-name' + nameCls + '"><span class="lb-name-btn" onclick="togglePicks(\'' + i + '\')">' + esc(s.name) + '</span></td><td class="lb-motms">' + s.goats + '</td><td class="lb-pts">' + s.bps.toLocaleString() + '</td></tr>';
    html += buildPicksRow(i, s.picks, gwFixtures || []);
  }

  if (myIdx >= 20) {
    const gap = myIdx - showCount;
    html += '<tr class="separator"><td colspan="4">\u00B7 \u00B7 \u00B7 ' + gap + ' entries \u00B7 \u00B7 \u00B7</td></tr>';
    html += '<tr class="my-row"><td class="lb-rank">' + myRank + '</td><td class="lb-name me"><span class="lb-name-btn" onclick="togglePicks(\'me\')">' + esc(myEntry.name) + '</span></td><td class="lb-motms">' + myEntry.goats + '</td><td class="lb-pts">' + myEntry.bps.toLocaleString() + '</td></tr>';
    html += buildPicksRow('me', myEntry.picks, gwFixtures || []);
  }

  html += '</tbody></table>';
  content.innerHTML = html;
}

function buildStandingsToggle() {
  return '<div class="lb-toggle">'
    + '<button class="lb-toggle-btn' + (standingsMode === 'gw' ? ' active' : '') + '" onclick="switchStandings(\'gw\')">Gameweek</button>'
    + '<button class="lb-toggle-btn' + (standingsMode === 'season' ? ' active' : '') + '" onclick="switchStandings(\'season\')">Season</button>'
    + '</div>';
}

async function loadSeasonStandings(content) {
  content.innerHTML = '<div class="loading-spinner">Loading season standings...</div>';

  // Get ALL picks across all GWs
  const { data: allPicks } = await sb.from('picks').select('user_id,gw,fixture_id,element_id').gte('gw', FIRST_GW);
  if (!allPicks || !allPicks.length) {
    content.innerHTML = buildStandingsToggle() + '<div class="empty-state"><span class="emoji">&#x1F3C6;</span><h3>No season data yet</h3><p>Season standings appear after picks are submitted</p></div>';
    return;
  }

  // Get ALL results for all fixtures with picks
  const allFixtureIds = [...new Set(allPicks.map(p => p.fixture_id))];
  // Fetch in batches of 200 to avoid URL length limits
  let allResults = [];
  for (let i = 0; i < allFixtureIds.length; i += 200) {
    const batch = allFixtureIds.slice(i, i + 200);
    const { data } = await sb.from('results').select('fixture_id,element_id,bps,is_goat').in('fixture_id', batch);
    if (data) allResults = allResults.concat(data);
  }

  // Build results lookup
  const resMap = {};
  allResults.forEach(r => {
    if (!resMap[r.fixture_id]) resMap[r.fixture_id] = {};
    resMap[r.fixture_id][r.element_id] = r;
  });

  // Aggregate per user: total GOATs, total BPS, GWs played
  const userTotals = {};
  allPicks.forEach(pick => {
    if (!userTotals[pick.user_id]) userTotals[pick.user_id] = { goats: 0, bps: 0, gws: new Set() };
    const r = resMap[pick.fixture_id] && resMap[pick.fixture_id][pick.element_id];
    const bps = r ? r.bps : 0;
    const isGoat = r ? r.is_goat : false;
    userTotals[pick.user_id].bps += bps;
    if (isGoat) userTotals[pick.user_id].goats++;
    userTotals[pick.user_id].gws.add(pick.gw);
  });

  // Get profiles
  const userIds = Object.keys(userTotals);
  const { data: profiles } = await sb.from('profiles').select('*').in('id', userIds);
  const profileMap = {};
  (profiles || []).forEach(p => { profileMap[p.id] = p; });

  // Sort: GOATs desc, BPS desc
  const sorted = userIds.map(uid => ({
    uid,
    name: profileMap[uid] ? profileMap[uid].team_name : 'Unknown',
    goats: userTotals[uid].goats,
    bps: userTotals[uid].bps,
    gwCount: userTotals[uid].gws.size
  })).sort((a, b) => b.goats - a.goats || b.bps - a.bps);

  // Find my position
  const myIdx = sorted.findIndex(s => s.uid === (currentUser ? currentUser.id : null));
  const myRank = myIdx >= 0 ? myIdx + 1 : '\u2013';
  const myEntry = myIdx >= 0 ? sorted[myIdx] : null;

  // Build HTML
  let html = buildStandingsToggle();
  html += '<div class="lb-header">';
  html += '<div style="font-size:14px;font-weight:900;color:#fff">SEASON STANDINGS</div>';
  html += '<div style="font-size:11px;color:#777;margin-top:4px">All gameweeks combined \u00B7 <span style="color:#BFB294;font-weight:700">' + sorted.length + ' managers</span></div>';
  html += '</div>';

  if (myEntry) {
    html += '<div class="lb-your-pos"><div>';
    html += '<div style="font-size:11px;color:#777;margin-bottom:2px">YOUR POSITION</div>';
    html += '<div class="lb-your-rank">#' + myRank + '</div>';
    html += '</div><div class="lb-your-info">' + esc(myEntry.name) + '<br><span>' + myEntry.goats + ' GOATs</span> \u00B7 <span>' + myEntry.bps.toLocaleString() + ' BPS</span> \u00B7 <span>' + myEntry.gwCount + ' GWs</span></div></div>';
  }

  html += '<table class="lb-table"><thead><tr><th>#</th><th>Player</th><th style="text-align:center">GOATs</th><th style="text-align:right">BPS</th></tr></thead><tbody>';

  const showCount = Math.min(20, sorted.length);
  for (let i = 0; i < showCount; i++) {
    const s = sorted[i];
    const rank = i + 1;
    const isMe = s.uid === (currentUser ? currentUser.id : null);
    const rankCls = rank <= 3 ? ' top3' : '';
    const nameCls = isMe ? ' me' : '';
    const rowCls = isMe ? ' class="my-row"' : '';
    html += '<tr' + rowCls + '><td class="lb-rank' + rankCls + '">' + rank + '</td><td class="lb-name' + nameCls + '">' + esc(s.name) + '</td><td class="lb-motms">' + s.goats + '</td><td class="lb-pts">' + s.bps.toLocaleString() + '</td></tr>';
  }

  if (myIdx >= 20) {
    const gap = myIdx - showCount;
    html += '<tr class="separator"><td colspan="4">\u00B7 \u00B7 \u00B7 ' + gap + ' entries \u00B7 \u00B7 \u00B7</td></tr>';
    html += '<tr class="my-row"><td class="lb-rank">' + myRank + '</td><td class="lb-name me">' + esc(myEntry.name) + '</td><td class="lb-motms">' + myEntry.goats + '</td><td class="lb-pts">' + myEntry.bps.toLocaleString() + '</td></tr>';
  }

  html += '</tbody></table>';
  content.innerHTML = html;
}

function buildPicksRow(rowId, picks, gwFixtures) {
  const sortedPicks = [...picks].sort((a, b) => {
    const fa = gwFixtures.find(x => x.id === a.fixture_id);
    const fb = gwFixtures.find(x => x.id === b.fixture_id);
    if (!fa || !fb) return 0;
    return new Date(fa.kickoff_time) - new Date(fb.kickoff_time);
  });

  let cells = '';
  for (const p of sortedPicks) {
    const f = gwFixtures.find(x => x.id === p.fixture_id);
    const pl = players[p.element_id];
    if (!f || !pl) continue;

    let matchLabel = f.home_short + ' \u2013 ' + f.away_short;
    if (f.status === 'ft') matchLabel += ' ' + f.home_score + '-' + f.away_score;
    else if (f.status === 'live') matchLabel += ' ' + f.home_score + '-' + f.away_score;
    const started = f.status === 'ft' || f.status === 'live';

    let playerText, rankText, bpsText;
    if (started) {
      playerText = esc(pl.short_name || pl.name) + ' (' + (pl.team_short||'') + ')' + (p.isGoat ? ' \uD83D\uDC51' : '');
      rankText = p.rank > 0 ? '#' + p.rank : '\u2013';
      bpsText = p.bps > 0 ? '' + p.bps : '';
    } else {
      playerText = '\u2014';
      rankText = '';
      bpsText = '';
    }

    cells += '<span class="lbp-match">' + matchLabel + '</span>'
      + '<span class="lbp-player' + (started ? '' : ' hidden') + '">' + playerText + '</span>'
      + '<span class="lbp-rank">' + rankText + '</span>'
      + '<span class="lbp-bps">' + bpsText + '</span>';
  }

  return '<tr class="lb-picks-row" id="picks-' + rowId + '" style="display:none"><td colspan="4"><div class="lbp-grid">' + cells + '</div></td></tr>';
}

// ===== PROFILE =====
async function loadProfileData() {
  if (!currentUser) return;
  document.getElementById('profile-email').value = currentUser.email || '';
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) {
    document.getElementById('profile-team-name').value = data.team_name || '';
    // Telegram section
    const hasT = !!data.telegram_chat_id;
    document.getElementById('tg-linked').style.display = hasT ? '' : 'none';
    document.getElementById('tg-not-linked').style.display = hasT ? 'none' : '';
  }
}

async function disconnectTelegram() {
  if (!confirm('Disconnect Telegram? You won\'t receive notifications.')) return;
  const { error } = await sb.from('profiles').update({ telegram_chat_id: null }).eq('id', currentUser.id);
  if (!error) {
    document.getElementById('tg-linked').style.display = 'none';
    document.getElementById('tg-not-linked').style.display = '';
  }
}

async function saveProfile() {
  const name = document.getElementById('profile-team-name').value.trim();
  if (!name) return;
  const { error } = await sb.from('profiles').update({ team_name: name, updated_at: new Date().toISOString() }).eq('id', currentUser.id);
  const msg = document.getElementById('profile-msg');
  if (error) { msg.textContent = 'Error: ' + error.message; msg.style.color = '#ff4444'; }
  else { msg.textContent = 'Saved!'; msg.style.color = '#4CAF50'; }
  setTimeout(() => { msg.textContent = ''; }, 3000);
}

// ===== PLAYER PROFILE MODAL =====
function openProfileFromCard(cardEl) {
  openProfile(
    parseInt(cardEl.dataset.eid),
    parseInt(cardEl.dataset.code),
    cardEl.dataset.name,
    cardEl.dataset.team,
    cardEl.dataset.pos,
    cardEl.dataset.ph
  );
}

async function openProfile(elementId, code, name, team, pos, ph) {
  const overlay = document.getElementById('mb-profile-overlay');
  const content = document.getElementById('mb-profile-content');
  overlay.style.display = 'flex';
  content.innerHTML = buildProfileHeader(name, team, pos, ph) + '<div class="mb-loading">Loading match history...</div>';

  try {
    // Try Supabase player_history first (fast, has bps_rank), fallback to FPL API
    const localData = await sb.from('player_history').select('*').eq('element_id', elementId).order('round', { ascending: true });

    let history;
    if (localData.data && localData.data.length > 0) {
      history = localData.data.map(r => ({
        fixture: r.fixture_id, round: r.round, opponent_team: r.opponent_team,
        was_home: r.was_home, kickoff_time: r.kickoff_time, minutes: r.minutes,
        bps: r.bps, total_points: r.total_points, goals_scored: r.goals_scored,
        assists: r.assists, clean_sheets: r.clean_sheets,
        yellow_cards: r.yellow_cards, red_cards: r.red_cards,
        bps_rank: r.bps_rank
      }));
    } else {
      const resp = await fetch('/api/player-detail?id=' + elementId);
      const data = await resp.json();
      if (!data.history) throw new Error('No history data');
      history = data.history;
    }

    content.innerHTML = buildProfileHeader(name, team, pos, ph)
      + buildProfileStats(history)
      + buildProfileHistory(history);
  } catch(e) {
    console.error('Profile load error:', e);
    content.innerHTML = buildProfileHeader(name, team, pos, ph)
      + buildProfileStatsMock()
      + '<div class="mb-api-note">\u26A0 Player data temporarily unavailable. Try again later.</div>';
  }
}

function closeProfile() { document.getElementById('mb-profile-overlay').style.display = 'none'; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeProfile(); closeAuthModal(); } });

function buildProfileHeader(name, team, pos, ph) {
  var col = POS_COLORS[pos] || '#BFB294';
  return '<div class="mb-profile-header">'
    + '<div class="mb-profile-hex-outer"><div class="mb-profile-hex-inner">'
    + (ph ? '<img src="' + ph + '" onerror="this.style.display=\'none\'" alt="">' : '')
    + '</div></div>'
    + '<div style="flex:1">'
    + '<div class="mb-profile-name">' + esc(name) + '</div>'
    + '<div class="mb-profile-detail">'
    + '<span class="mb-pos-badge" style="background:' + col + '">' + pos + '</span>'
    + '<span>' + esc(team) + '</span>'
    + '</div></div></div>';
}

function buildProfileStats(history) {
  if (!history || !history.length) return buildProfileStatsMock();
  var played = history.filter(h => h.minutes > 0);
  // If bps_rank is missing, calculate it from BPS per fixture
  var byFixture = {};
  played.forEach(h => { if (!byFixture[h.fixture_id]) byFixture[h.fixture_id] = []; byFixture[h.fixture_id].push(h); });
  Object.values(byFixture).forEach(rows => { rows.sort((a,b) => b.bps - a.bps); rows.forEach((r,i) => { if (!r.bps_rank) r.bps_rank = i + 1; }); });
  var ranked = played.filter(h => h.bps_rank);
  var goatCount = ranked.filter(h => h.bps_rank === 1).length;
  var avgRank = ranked.length > 0 ? (ranked.reduce((s, h) => s + h.bps_rank, 0) / ranked.length).toFixed(1) : '-';
  // Form: avg BPS over last 6 GWs (missed GWs = 0)
  var mr = statsMaxRound || Math.max.apply(null, history.map(function(h) { return h.round; }));
  var formStart = Math.max(1, mr - 5);
  var byRound = {};
  history.forEach(function(h) { byRound[h.round] = h; });
  var formBpsSum = 0;
  for (var gw = formStart; gw <= mr; gw++) {
    var h = byRound[gw];
    if (h && h.minutes > 0) formBpsSum += (h.bps || 0);
  }
  var formBps = (formBpsSum / 6).toFixed(1);
  var totalBps = played.reduce((s, h) => s + (h.bps || 0), 0);
  return '<div class="mb-profile-stats">'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + goatCount + ' \uD83D\uDC51</div><div class="mb-stat-label">GOATs</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + avgRank + '</div><div class="mb-stat-label">Avg Rank</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + formBps + '</div><div class="mb-stat-label">Form (L6)</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + totalBps + '</div><div class="mb-stat-label">BPS Total</div></div>'
    + '</div>';
}

function buildProfileStatsMock() {
  return '<div class="mb-profile-stats">'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">BPS Total</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">Form</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">Games</div></div>'
    + '</div>';
}

function buildProfileHistory(history) {
  if (!history || !history.length) {
    return '<div class="mb-history-title">Season History</div><p style="padding:20px;color:#555;text-align:center;font-size:12px">No match history available</p>';
  }
  // Ensure bps_rank exists (fallback calc for old data)
  var byFix = {};
  history.forEach(function(h) { if (h.minutes > 0) { if (!byFix[h.fixture_id]) byFix[h.fixture_id] = []; byFix[h.fixture_id].push(h); } });
  Object.values(byFix).forEach(function(rows) { rows.sort(function(a,b) { return b.bps - a.bps; }); rows.forEach(function(r,i) { if (!r.bps_rank) r.bps_rank = i + 1; }); });
  // Build lookup by round
  var byRound = {};
  history.forEach(function(h) { byRound[h.round] = h; });
  // Use global max round so all GWs are shown even if player missed recent ones
  var maxRound = statsMaxRound || Math.max.apply(null, history.map(function(h) { return h.round; }));
  var rows = '';
  // Show all GWs from most recent to GW1
  for (var gw = maxRound; gw >= 1; gw--) {
    var h = byRound[gw];
    if (h && h.minutes > 0) {
      var opp = FPL_TEAM_MAP[h.opponent_team] || '?';
      var ha = h.was_home ? '(H)' : '(A)';
      var bps = h.bps || 0;
      var rank = h.bps_rank;
      var rankHtml = '';
      if (rank === 1) rankHtml = ' <span style="color:#BFB294">\uD83D\uDC51</span>';
      else if (rank && rank <= 3) rankHtml = ' <span style="color:#8a8060;font-size:10px">(' + rank + ')</span>';
      else if (rank) rankHtml = ' <span style="color:#555;font-size:10px">(' + rank + ')</span>';
      var rowCls = rank === 1 ? ' class="goat-row"' : '';
      rows += '<tr' + rowCls + '><td>GW' + gw + '</td><td>' + opp + ' ' + ha + '</td><td>' + h.minutes + "'" + '</td><td class="td-bps">' + bps + rankHtml + '</td></tr>';
    } else {
      rows += '<tr style="opacity:0.35"><td>GW' + gw + '</td><td>\u2014</td><td>\u2014</td><td class="td-bps">\u2014</td></tr>';
    }
  }
  return '<div class="mb-history-title">Season History</div>'
    + '<div class="mb-history-wrap"><table class="mb-history-table">'
    + '<thead><tr><th>GW</th><th>Opp</th><th>Min</th><th>BPS / Rank</th></tr></thead>'
    + '<tbody>' + rows + '</tbody>'
    + '</table></div>';
}

// ===== NAVIGATION HELPERS =====
function goToMatch(fixtureId) {
  if (isViewGWPickLocked()) return;
  switchTab('pick');
  setTimeout(function() {
    var el = document.getElementById('match-' + fixtureId);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// ===== UI HELPERS =====
function switchTab(name) {
  // Close My Team change panel on tab switch
  if (changingFixtureId) mtClosePanel();
  // Prevent switching to locked pick tab
  if (name === 'pick' && isViewGWPickLocked()) return;

  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.getElementById('tab-btn-' + name).classList.add('active');

  // Show/hide team strip — only show on pick tab for active GW
  var strip = document.getElementById('team-strip');
  if (strip) strip.style.display = (name === 'pick' && viewGW >= activeGW) ? '' : 'none';

  closeMenu();

  // Refresh data when switching tabs
  if (name === 'pick') { loadFixtures().then(() => { renderPickTab(); }); }
  if (name === 'live') renderLiveTab();
  if (name === 'myteam') { Promise.all([loadFixtures(), loadResults()]).then(() => renderMyTeam()); }
  if (name === 'standings') { loadStandings(viewGW); }
}

function togglePicks(rowId) {
  var row = document.getElementById('picks-' + rowId);
  if (!row) return;
  var isOpen = row.style.display !== 'none';
  document.querySelectorAll('.lb-picks-row').forEach(r => { r.style.display = 'none'; });
  if (!isOpen) row.style.display = '';
}

function toggleMenu() {
  document.getElementById('nav-dropdown').classList.toggle('open');
}

function closeMenu() {
  document.getElementById('nav-dropdown').classList.remove('open');
}

async function shareApp() {
  closeMenu();
  const shareData = {
    title: 'GOAT — Pick the Greatest',
    text: 'Pick the best player for every Premier League match. No budget, no transfers — just pure prediction skill.',
    url: 'https://goatapp.club'
  };
  if (navigator.share) {
    try { await navigator.share(shareData); } catch(e) {}
  } else {
    try {
      await navigator.clipboard.writeText('Join me on GOAT — pick the best player for every Premier League match!\nhttps://goatapp.club');
      showToast('Link copied!');
    } catch(e) {
      showToast('Share: goatapp.club');
    }
  }
}

// Close menu on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.nav-right')) closeMenu();
});

function openPage(name) {
  document.getElementById('page-' + name).classList.add('open');
  closeMenu();
}

function closePage(name) {
  document.getElementById('page-' + name).classList.remove('open');
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== HASH ROUTING (browser back/forward) =====
window.addEventListener('hashchange', function() {
  if (!activeGW) return;
  const hashGW = parseGWFromHash();
  if (hashGW && hashGW >= FIRST_GW && hashGW <= (maxGW || activeGW) && hashGW !== viewGW) {
    loadGWData(hashGW);
  }
});

// ===== AUTO-REFRESH (every 60s when on Live tab, only for active GW) =====
setInterval(function() {
  var liveTab = document.getElementById('tab-live');
  if (liveTab && liveTab.classList.contains('active') && viewGW === activeGW) {
    renderLiveTab();
  }
}, 60000);

// ===== INIT =====
// Handle email input enter key
document.getElementById('auth-email').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') handleAuth();
});

initAuth();
</script>
</body>
</html>
