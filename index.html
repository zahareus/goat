<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOAT — Pick the Greatest</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="preconnect" href="https://zanssnurnzdqwaxuadge.supabase.co" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#1a1a1a;
  background-image:url("data:image/svg+xml,%3Csvg width='28' height='32' viewBox='0 0 28 32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M14 1 L27 8 L27 24 L14 31 L1 24 L1 8 Z' fill='none' stroke='%23222' stroke-width='1'/%3E%3C/svg%3E");
  color:#f0f0f0;
  font-family:'Arial',sans-serif;
  min-height:100vh;
  user-select:none;
}

/* ===== AUTH GATE ===== */
.auth-screen{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;padding:24px;
}
.auth-logo{width:120px;height:120px;margin-bottom:24px}
.auth-title{font-size:28px;font-weight:900;letter-spacing:6px;color:#fff;margin-bottom:6px}
.auth-sub{font-size:12px;color:#777;letter-spacing:1px;margin-bottom:36px}
.auth-box{
  background:#111;border:1px solid #2a2a2a;padding:28px 24px;
  width:min(380px,100%);
}
.auth-box h2{font-size:14px;font-weight:700;color:#BFB294;letter-spacing:1px;text-transform:uppercase;margin-bottom:16px}
.auth-input{
  width:100%;background:#1a1a1a;border:1px solid #333;color:#fff;
  padding:12px 14px;font-size:14px;margin-bottom:14px;outline:none;
}
.auth-input:focus{border-color:#BFB294}
.auth-btn{
  width:100%;background:#BFB294;color:#111;border:none;
  padding:12px;font-size:13px;font-weight:900;text-transform:uppercase;letter-spacing:1px;
  cursor:pointer;
}
.auth-btn:hover{background:#d4c9a8}
.auth-btn:disabled{opacity:0.5;cursor:not-allowed}
.auth-msg{font-size:12px;color:#777;margin-top:14px;text-align:center;min-height:18px}
.auth-msg.error{color:#ff4444}
.auth-msg.success{color:#4CAF50}

/* ===== NAV ===== */
.app-wrap{display:none}
.nav{
  background:#0d0d0d;border-bottom:1px solid #2a2a2a;
  padding:0 20px;display:flex;align-items:center;justify-content:space-between;
  height:56px;position:sticky;top:0;z-index:200;
}
.nav-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
.nav-logo-img{width:36px;height:36px;object-fit:contain}
.nav-logo-text{font-size:16px;font-weight:900;color:#fff;letter-spacing:3px;text-transform:uppercase}
.nav-center{display:flex;align-items:center;gap:8px}
.gw-nav-arrow{background:none;border:none;color:#666;font-size:18px;cursor:pointer;padding:4px 8px;transition:color .15s}
.gw-nav-arrow:hover{color:#BFB294}
.gw-nav-arrow:disabled{color:#333;cursor:not-allowed}
.gw-nav-label{font-size:14px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase;min-width:60px;text-align:center}
.nav-right{display:flex;align-items:center;gap:12px;position:relative}
.nav-menu-btn{
  display:flex;align-items:center;gap:6px;cursor:pointer;color:#aaa;
  font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  background:none;border:none;padding:6px 0;
}
.nav-menu-btn:hover{color:#fff}
.nav-dropdown{
  display:none;position:absolute;top:44px;right:0;
  background:#111;border:1px solid #2a2a2a;min-width:180px;z-index:300;
}
.nav-dropdown.open{display:block}
.nav-dropdown a{
  display:block;padding:12px 16px;color:#ccc;font-size:12px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.5px;text-decoration:none;
  border-bottom:1px solid #1e1e1e;cursor:pointer;
}
.nav-dropdown a:hover{background:#1a1a1a;color:#BFB294}
.nav-dropdown a:last-child{border-bottom:none}

/* ===== TABS ===== */
.tabs{display:flex;background:#111;border-bottom:1px solid #2a2a2a;position:sticky;top:56px;z-index:190}
.tab{
  flex:1;padding:13px 8px;text-align:center;font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:1px;color:#666;cursor:pointer;
  border-bottom:3px solid transparent;transition:all .2s;
}
.tab.active{color:#BFB294;border-bottom-color:#BFB294}
.tab.locked{color:#444;cursor:not-allowed;pointer-events:none}
.tab.locked .lock-icon{display:inline;font-size:9px;margin-left:2px}
.tab-content{display:none}
.tab-content.active{display:block}

/* ===== PICK TAB ===== */
.gw-header{
  text-align:center;padding:18px 16px 14px;
  background:linear-gradient(180deg,#111 0%,#161616 100%);
  border-bottom:1px solid #2a2a2a;
}
.gw-title{font-size:15px;font-weight:900;color:#fff;letter-spacing:3px;text-transform:uppercase}
.gw-sub{font-size:10px;color:#777;margin-top:4px;letter-spacing:0.5px}

/* Match block */
.match-block{margin-bottom:2px;background:#161616}
.match-header{
  background:#1e1e1e;border-left:3px solid #BFB294;
  padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
}
.match-header-left{display:flex;align-items:center;gap:14px}
.match-num-hex{
  width:34px;height:39px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:900;color:#111;flex-shrink:0;
}
.match-teams-wrap{}
.match-teams{font-size:15px;font-weight:900;color:#fff;letter-spacing:0.5px}
.match-teams span{color:#BFB294;margin:0 8px;font-size:12px}
.match-time{font-size:10px;color:#888;margin-top:2px;letter-spacing:0.3px}
.match-locked{font-size:9px;color:#ff4444;font-weight:700;letter-spacing:0.5px}
.match-selected-badge{
  font-size:10px;background:#BFB294;color:#111;
  padding:3px 10px;font-weight:700;letter-spacing:0.3px;
}

/* Position filter tabs */
.pos-tabs{display:flex;background:#141414;border-bottom:1px solid #222;padding:0 16px}
.pos-tab{
  padding:9px 14px;font-size:10px;font-weight:700;color:#555;
  cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;
  text-transform:uppercase;letter-spacing:0.8px;
}
.pos-tab.active{color:#BFB294;border-bottom-color:#BFB294}
.pos-tab:hover:not(.active){color:#aaa}

/* Horizontal player row */
.player-row-outer{overflow-x:auto;scrollbar-width:none;background:#1a1a1a;padding:16px 0 12px}
.player-row-outer::-webkit-scrollbar{display:none}
.player-row{display:flex;align-items:flex-start;gap:6px;padding:0 16px;min-width:max-content}

/* Individual player card */
.phex-card{
  display:flex;flex-direction:column;align-items:center;gap:5px;
  cursor:pointer;width:82px;transition:transform .15s;
}
.phex-card:hover:not(.selected){transform:translateY(-4px)}
.phex-card:hover:not(.selected) .phex-outer{background:#BFB294}
.phex-card.hidden{display:none!important}
.phex-outer{
  width:76px;height:87px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2e2e2e;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.phex-outer.selected{background:#BFB294}
.phex-inner{
  width:68px;height:78px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.phex-outer.selected .phex-inner{background:#2a2216}
.phex-inner img{width:100%;height:120%;object-fit:cover;object-position:top center;display:block}
.phex-team-pos{font-size:9px;color:#666;text-align:center;line-height:1.5}
.phex-stat{font-size:8px;color:#8a8060;text-align:center;line-height:1.3;white-space:nowrap}
.phex-card.selected .phex-team-pos{color:#BFB294;opacity:0.8}

/* Player name wrap + info button */
.phex-name-wrap{position:relative;display:flex;align-items:center;justify-content:center;gap:2px;width:82px;height:14px}
.phex-name{
  font-size:10px;font-weight:700;color:#ccc;text-align:center;
  white-space:nowrap;max-width:68px;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;transition:color .15s;
}
.phex-name:hover{color:#fff}
.phex-card.selected .phex-name{color:#BFB294}
.phex-info-btn{
  display:none;width:13px;height:13px;border-radius:50%;flex-shrink:0;
  background:#BFB294;color:#0d0d0d;font-size:8px;font-weight:900;font-style:normal;
  align-items:center;justify-content:center;cursor:pointer;line-height:1;transition:background .15s;
}
.phex-info-btn:hover{background:#fff}
.phex-card:hover .phex-info-btn{display:flex}

/* Profile modal overlay */
#mb-profile-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.88);
  display:none;align-items:flex-start;justify-content:center;
  z-index:1000;overflow-y:auto;padding:40px 16px;box-sizing:border-box;
}
.mb-profile-panel{background:#1a1a1a;border:1px solid #BFB294;width:min(520px,100%);border-radius:4px;position:relative;margin:auto}
.mb-profile-close{position:absolute;top:10px;right:14px;color:#666;font-size:24px;cursor:pointer;line-height:1;z-index:10}
.mb-profile-close:hover{color:#fff}
.mb-profile-header{display:flex;align-items:center;gap:20px;padding:24px 24px 20px;border-bottom:1px solid #2e2e2e}
.mb-profile-hex-outer{
  width:90px;height:103px;flex-shrink:0;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
}
.mb-profile-hex-inner{
  width:82px;height:94px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2216;overflow:hidden;
}
.mb-profile-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top center}
.mb-profile-name{font-size:20px;font-weight:700;color:#fff;margin-bottom:6px}
.mb-profile-detail{font-size:12px;color:#888;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.mb-pos-badge{display:inline-block;padding:2px 8px;border-radius:2px;font-size:10px;font-weight:700;color:#0d0d0d;background:#BFB294}
.mb-profile-stats{display:flex;border-bottom:1px solid #2e2e2e}
.mb-stat-block{flex:1;text-align:center;padding:18px 8px;border-right:1px solid #2e2e2e}
.mb-stat-block:last-child{border-right:none}
.mb-stat-val{font-size:24px;font-weight:700;color:#BFB294}
.mb-stat-label{font-size:9px;color:#555;margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.mb-history-title{padding:14px 20px 10px;font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #2e2e2e}
.mb-history-wrap{padding:0 0 8px}
.mb-history-table{width:100%;border-collapse:collapse;font-size:11px}
.mb-history-table th{padding:8px 12px;text-align:left;color:#555;font-weight:600;text-transform:uppercase;font-size:9px;letter-spacing:.5px;border-bottom:1px solid #2e2e2e}
.mb-history-table td{padding:7px 12px;border-bottom:1px solid #1e1e1e;color:#bbb}
.mb-history-table tr:last-child td{border-bottom:none}
.mb-history-table tr:hover td{background:#222}
.mb-history-table .td-bps{color:#BFB294;font-weight:700}
.mb-history-table .td-mb{text-align:center;font-size:13px}
.mb-loading{text-align:center;padding:40px;color:#BFB294;font-size:13px}
.mb-api-note{padding:8px 20px 16px;font-size:10px;color:#3a3a3a;font-style:italic}
tr.goat-row{background:#2a2510}
tr.goat-row .td-bps{color:#BFB294;font-weight:900}

/* Team strip (sticky bottom) */
.team-strip{
  position:fixed;bottom:0;left:0;right:0;
  background:#0d0d0d;border-top:2px solid #BFB294;
  padding:8px 16px;display:flex;align-items:center;gap:5px;z-index:300;
}
.strip-label{font-size:9px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-right:4px;white-space:nowrap}
#strip-slots{display:flex;gap:3px;overflow-x:auto;flex:1;align-items:center}
.strip-slot{
  width:28px;height:32px;flex-shrink:0;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#222;overflow:hidden;display:flex;align-items:center;justify-content:center;
}
.strip-slot.filled{background:#BFB294}
.strip-slot img{width:100%;height:120%;object-fit:cover;object-position:top}
.strip-count{font-size:11px;color:#BFB294;font-weight:700;margin-left:2px;white-space:nowrap}
.strip-submit{
  margin-left:auto;background:#BFB294;color:#111;border:none;
  padding:8px 18px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1px;cursor:pointer;flex-shrink:0;
}
.strip-submit:hover{background:#d4c9a8}
.strip-submit:disabled{opacity:0.5;cursor:not-allowed}
.pick-spacer{height:60px}

/* ===== LIVE TAB ===== */
.live-nav{
  display:flex;overflow-x:auto;background:#111;padding:0 8px;gap:2px;
  border-bottom:1px solid #2a2a2a;scrollbar-width:none;
}
.live-nav::-webkit-scrollbar{display:none}
.live-match-btn{
  flex-shrink:0;padding:10px 14px;font-size:11px;font-weight:700;
  color:#777;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;
}
.live-match-btn.active{color:#BFB294;border-bottom-color:#BFB294}
.live-match-btn .score{color:#fff}
.live-dot{display:inline-block;width:6px;height:6px;background:#ff4444;border-radius:50%;margin-right:4px;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.live-nav-min{color:#ff4444;font-weight:700}
.live-nav-ft{color:#666}
.live-nav-time{color:#888}
.live-header{padding:16px;background:#1a1a1a;border-bottom:1px solid #2a2a2a}
.live-score-row{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px}
.live-team-name{font-size:18px;font-weight:900;color:#fff}
.live-score{font-size:32px;font-weight:900;color:#BFB294}
.live-minute{font-size:12px;color:#ff4444;font-weight:700}
.events-bar{
  display:flex;gap:16px;padding:8px 16px;
  background:#1a1a1a;border-bottom:1px solid #2a2a2a;
  overflow-x:auto;font-size:11px;color:#888;white-space:nowrap;
}
.live-strip-section{background:#1a1a1a;padding-bottom:100px}
.live-strip-wrap{overflow-x:auto;scrollbar-width:none;padding:16px 16px 8px}
.live-strip-wrap::-webkit-scrollbar{display:none}
.live-strip{display:flex;gap:10px;min-width:max-content}
.lv-card{
  width:106px;background:#1e1e1e;border:1px solid #2a2a2a;
  display:flex;flex-direction:column;align-items:center;
  padding:8px 6px 10px;gap:5px;position:relative;transition:transform .15s;
}
.lv-card:hover{transform:translateY(-4px)}
.lv-card:hover .lv-hex-outer{background:#BFB294}
.lv-card.lv-motm{background:#BFB294;border-color:#8a7050}
.lv-card.lv-yours{background:#1e1e1e;border:2px solid #BFB294}
.lv-hex-wrap{position:relative;width:68px;height:78px;margin:2px 0}
.lv-hex-outer{
  width:68px;height:78px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#333;display:flex;align-items:center;justify-content:center;
}
.lv-card.lv-motm .lv-hex-outer{background:#7a6040}
.lv-card.lv-yours .lv-hex-outer{background:#BFB294}
.lv-hex-inner{
  width:61px;height:70px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.lv-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top}
.lv-rank-badge{
  position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);
  width:22px;height:25px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2a2a;display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:900;color:#fff;
}
.lv-card.lv-motm .lv-rank-badge{background:#111;color:#fff}
.lv-card.lv-yours .lv-rank-badge{background:#BFB294;color:#111}
.lv-name{font-size:10px;font-weight:700;color:#ddd;text-align:center;white-space:nowrap;max-width:98px;overflow:hidden;text-overflow:ellipsis;margin-top:4px}
.lv-card.lv-motm .lv-name{color:#111}
.lv-pos{font-size:8px;color:#777;text-transform:uppercase;letter-spacing:0.5px}
.lv-card.lv-motm .lv-pos{color:#4a3820}
.lv-bps{background:#222;width:100%;text-align:center;font-size:15px;font-weight:900;color:#fff;padding:4px 0}
.lv-card.lv-motm .lv-bps{color:#fff;background:#7a6040}
.lv-nav-rank{
  display:inline-flex;width:14px;height:16px;margin-left:3px;vertical-align:middle;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#2a2a2a;align-items:center;justify-content:center;
  font-size:7px;font-weight:900;color:#fff;
}
.lv-nav-rank.lv-rank-motm{background:#BFB294;color:#111}

/* ===== MY TEAM TAB (mt2) ===== */
.mt2-section{padding:20px 0 80px;background:#1a1a1a}
.mt2-title{text-align:center;font-size:12px;font-weight:900;color:#BFB294;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.mt2-subtitle{text-align:center;font-size:10px;color:#666;margin-bottom:16px;letter-spacing:0.3px}
.mt2-scroll-wrap{overflow-x:auto;scrollbar-width:none;padding:0 16px 8px}
.mt2-scroll-wrap::-webkit-scrollbar{display:none}
.mt2-strip{display:flex;gap:10px;min-width:max-content}
.mt2-card{
  width:120px;background:#1e1e1e;border:2px solid #BFB294;
  display:flex;flex-direction:column;align-items:center;
  padding:8px 6px 10px;gap:4px;position:relative;transition:transform .15s;
}
.mt2-card:hover{transform:translateY(-4px)}
.mt2-card:hover .mt2-hex-outer{background:#d4c5a0}
.mt2-card.motm{background:#BFB294;border-color:#8a7050}
.mt2-card.motm:hover .mt2-hex-outer{background:#6a5030}
.mt2-match{font-size:9px;font-weight:700;color:#aaa;letter-spacing:0.3px;text-align:center}
.mt2-card.motm .mt2-match{color:#3a2810}
.mt2-status{font-size:9px;font-weight:700;color:#666;letter-spacing:0.5px}
.mt2-status.live{color:#ff4444}
.mt2-card.motm .mt2-status{color:#6a5030}
.mt2-card.motm .mt2-status.live{color:#cc2222}
.mt2-hex-wrap{position:relative;width:76px;height:87px;margin:2px 0}
.mt2-hex-outer{
  width:76px;height:87px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.mt2-card.motm .mt2-hex-outer{background:#7a6040}
.mt2-hex-inner{
  width:69px;height:79px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#1e1e1e;overflow:hidden;
}
.mt2-card.motm .mt2-hex-inner{background:#BFB294}
.mt2-hex-inner img{width:100%;height:120%;object-fit:cover;object-position:top}
.mt2-rank-badge{
  position:absolute;bottom:-4px;left:50%;transform:translateX(-50%);
  width:24px;height:28px;
  clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  background:#BFB294;display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:900;color:#111;
}
.mt2-card.motm .mt2-rank-badge{background:#111;color:#fff}
.mt2-name{font-size:10px;font-weight:700;color:#ddd;text-align:center;white-space:nowrap;max-width:110px;overflow:hidden;text-overflow:ellipsis;margin-top:5px}
.mt2-card.motm .mt2-name{color:#111}
.mt2-pos{font-size:8px;color:#777;text-transform:uppercase;letter-spacing:0.5px}
.mt2-card.motm .mt2-pos{color:#4a3820}
.mt2-bps{background:#222;width:100%;text-align:center;font-size:15px;font-weight:900;color:#fff;padding:4px 0}
.mt2-bps.pending{background:#1a1a1a;font-size:11px;color:#444;letter-spacing:0.5px}
.mt2-card.motm .mt2-bps{background:#7a6040;color:#fff}

/* ===== LEADERBOARD TAB ===== */
.lb-header{background:#1a1a1a;padding:14px 16px;border-bottom:1px solid #2a2a2a}
.lb-your-pos{
  background:linear-gradient(135deg,#1a1a12 0%,#222215 100%);
  border:1px solid #BFB294;padding:12px 16px;margin:12px 16px;
  display:flex;align-items:center;justify-content:space-between;
}
.lb-your-rank{font-size:32px;font-weight:900;color:#BFB294}
.lb-your-info{font-size:12px;color:#aaa}
.lb-your-info span{color:#fff;font-weight:700}
.lb-table{width:100%;border-collapse:collapse;font-size:12px}
.lb-table th{
  text-align:left;padding:8px 12px;background:#1a1a1a;
  color:#777;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;
  border-bottom:1px solid #2a2a2a;
}
.lb-table td{padding:10px 12px;border-bottom:1px solid #1e1e1e;vertical-align:middle}
.lb-rank{font-weight:900;color:#BFB294;width:36px}
.lb-rank.top3{color:#ffd700}
.lb-name{font-weight:700;color:#ddd;font-size:14px}
.lb-name.me{color:#BFB294}
.lb-name-btn{cursor:pointer}
.lb-name-btn:hover{color:#BFB294;text-decoration:underline;text-decoration-color:#BFB29466}
.lb-motms{color:#BFB294;font-weight:700;text-align:center}
.lb-pts{color:#fff;font-weight:700;text-align:right}
tr.my-row{background:#1a1a12}
tr.separator td{padding:4px 12px;color:#555;font-size:10px;text-align:center;background:#111}
tr.lb-picks-row{background:#111}
tr.lb-picks-row td{padding:6px 12px 10px}
.lb-picks-list{display:flex;flex-direction:column;gap:3px}
.lb-pick-item{display:flex;gap:10px;font-size:11px;align-items:baseline}
.lb-pick-match{color:#666;min-width:72px;font-weight:700}
.lb-pick-st{min-width:52px;color:#777}
.lb-pick-st.live{color:#ff4444;font-weight:700}
.lb-pick-st.ft{color:#555}
.lb-pick-player{color:#ccc;font-weight:700}
.lb-pick-rank{color:#BFB294;font-weight:900;margin-left:4px}
.lb-pick-motm{color:#ffd700;font-size:10px;margin-left:2px}

/* ===== RULES PAGE ===== */
.page-overlay{
  display:none;position:fixed;inset:0;background:#1a1a1a;z-index:400;overflow-y:auto;
}
.page-overlay.open{display:block}
.page-header{
  background:#0d0d0d;border-bottom:1px solid #2a2a2a;
  padding:16px 20px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:10;
}
.page-back{
  background:none;border:1px solid #BFB294;color:#BFB294;
  padding:6px 14px;font-size:11px;font-weight:700;cursor:pointer;text-transform:uppercase;
}
.page-back:hover{background:#BFB294;color:#111}
.page-title{font-size:16px;font-weight:900;color:#fff;letter-spacing:2px;text-transform:uppercase}
.page-body{padding:24px 20px;max-width:640px;margin:0 auto}
.page-body h3{color:#BFB294;font-size:14px;font-weight:900;letter-spacing:1px;text-transform:uppercase;margin:24px 0 10px}
.page-body h3:first-child{margin-top:0}
.page-body p{color:#bbb;font-size:13px;line-height:1.7;margin-bottom:12px}
.page-body ul{color:#bbb;font-size:13px;line-height:1.8;padding-left:20px;margin-bottom:12px}
.page-body li{margin-bottom:4px}
.page-body strong{color:#fff}

/* ===== PROFILE PAGE ===== */
.profile-form{max-width:400px;margin:0 auto;padding:32px 20px}
.profile-label{font-size:10px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block}
.profile-input{
  width:100%;background:#1a1a1a;border:1px solid #333;color:#fff;
  padding:12px 14px;font-size:14px;margin-bottom:20px;outline:none;
}
.profile-input:focus{border-color:#BFB294}
.profile-input:disabled{opacity:0.5}
.profile-save{
  background:#BFB294;color:#111;border:none;padding:12px 24px;
  font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:1px;cursor:pointer;
}
.profile-save:hover{background:#d4c9a8}
.profile-msg{font-size:12px;color:#4CAF50;margin-top:10px;min-height:18px}

/* Change button on My Team cards */
.mt2-change{
  margin-top:4px;font-size:10px;color:#BFB294;cursor:pointer;
  border:1px solid #BFB294;padding:3px 10px;text-transform:uppercase;
  letter-spacing:0.5px;font-weight:700;
}
.mt2-change:hover{background:#BFB294;color:#111}

/* ===== EMPTY / LOADING STATES ===== */
.empty-state{text-align:center;padding:60px 24px;color:#555}
.empty-state .emoji{font-size:48px;margin-bottom:16px;display:block}
.empty-state h3{color:#888;font-size:14px;font-weight:700;margin-bottom:8px}
.empty-state p{font-size:12px;color:#555;line-height:1.6}
.loading-spinner{text-align:center;padding:60px;color:#BFB294;font-size:13px}

/* ===== TOAST ===== */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  background:#BFB294;color:#111;padding:10px 24px;font-size:12px;font-weight:700;
  letter-spacing:0.5px;z-index:500;opacity:0;transition:opacity .3s;pointer-events:none;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div id="auth-screen" class="auth-screen">
  <img src="assets/logo.png" class="auth-logo" alt="GOAT">
  <div class="auth-sub">Pick the Greatest of All Time</div>
  <div class="auth-box">
    <h2>Sign in with Email</h2>
    <input type="email" id="auth-email" class="auth-input" placeholder="your@email.com" autocomplete="email">
    <button id="auth-submit" class="auth-btn" onclick="handleAuth()">Send Magic Link</button>
    <div id="auth-msg" class="auth-msg"></div>
  </div>
</div>

<!-- ===== APP (hidden until auth) ===== -->
<div id="app-wrap" class="app-wrap">

<!-- NAV -->
<div class="nav">
  <div class="nav-logo" onclick="goHome()">
    <img src="assets/logo.png" class="nav-logo-img" alt="">
    <div class="nav-logo-text">GOAT</div>
  </div>
  <div class="nav-center">
    <button class="gw-nav-arrow" id="gw-prev" onclick="changeViewGW(-1)">&larr;</button>
    <span class="gw-nav-label" id="gw-nav-label">GW --</span>
    <button class="gw-nav-arrow" id="gw-next" onclick="changeViewGW(1)">&rarr;</button>
  </div>
  <div class="nav-right">
    <button class="nav-menu-btn" onclick="toggleMenu()">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="#aaa"><circle cx="8" cy="8" r="7" stroke="#aaa" stroke-width="1" fill="none"/><circle cx="8" cy="6" r="2.5" fill="#aaa"/><path d="M3 13c0-2.8 2.2-4.5 5-4.5s5 1.7 5 4.5" stroke="#aaa" stroke-width="1" fill="none"/></svg>
      Menu
    </button>
    <div id="nav-dropdown" class="nav-dropdown">
      <a onclick="openPage('profile')">Profile</a>
      <a onclick="openPage('rules')">Rules</a>
      <a onclick="handleSignOut()">Sign Out</a>
    </div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" id="tab-btn-pick" onclick="switchTab('pick')">Pick Team</div>
  <div class="tab" id="tab-btn-myteam" onclick="switchTab('myteam')">My Team</div>
  <div class="tab" id="tab-btn-live" onclick="switchTab('live')">Live</div>
  <div class="tab" id="tab-btn-standings" onclick="switchTab('standings')">Standings</div>
</div>

<!-- TAB 1: PICK TEAM -->
<div id="tab-pick" class="tab-content active">
  <div class="gw-header">
    <div class="gw-title" id="pick-gw-title">Loading...</div>
    <div class="gw-sub" id="pick-gw-sub"></div>
  </div>
  <div id="pick-matches"><div class="loading-spinner">Loading fixtures...</div></div>
  <div class="pick-spacer"></div>
  <div class="team-strip" id="team-strip">
    <div class="strip-label">Team</div>
    <div id="strip-slots"></div>
    <div class="strip-count" id="strip-count">0/0</div>
    <button class="strip-submit" id="strip-submit" onclick="submitPicks()">Submit</button>
  </div>
</div>

<!-- TAB 2: LIVE -->
<div id="tab-live" class="tab-content">
  <div class="live-nav" id="live-nav"></div>
  <div id="live-match-content">
    <div class="empty-state">
      <span class="emoji">&#x26BD;</span>
      <h3>No live matches</h3>
      <p>Live BPS data will appear here during matchdays</p>
    </div>
  </div>
</div>

<!-- TAB 3: MY TEAM -->
<div id="tab-myteam" class="tab-content">
  <div class="mt2-section">
    <div class="mt2-title" id="mt-title">My GOAT Picks</div>
    <div class="mt2-subtitle" id="mt-subtitle"></div>
    <div class="mt2-scroll-wrap">
      <div class="mt2-strip" id="mt-strip">
        <div class="empty-state" style="min-width:100vw">
          <span class="emoji">&#x1F90C;</span>
          <h3>No picks yet</h3>
          <p>Pick your GOATs on the Pick Team tab</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TAB 4: STANDINGS -->
<div id="tab-standings" class="tab-content">
  <div id="standings-content">
    <div class="loading-spinner">Loading standings...</div>
  </div>
</div>

</div><!-- /app-wrap -->

<!-- RULES PAGE -->
<div id="page-rules" class="page-overlay">
  <div class="page-header">
    <button class="page-back" onclick="closePage('rules')">&larr; Back</button>
    <div class="page-title">Rules</div>
  </div>
  <div class="page-body">
    <h3>How to Play</h3>
    <p>GOAT is a fantasy game where you pick the <strong>Greatest Of All Time</strong> (best performer) for each Premier League match in a gameweek.</p>

    <h3>Picking</h3>
    <ul>
      <li>For each match in the gameweek, pick <strong>one player</strong> you think will be the GOAT (highest BPS)</li>
      <li>You can pick from <strong>either team</strong> in each match</li>
      <li>Picks lock at <strong>kickoff</strong> of each individual match</li>
      <li>You can change your pick any time before that match kicks off</li>
    </ul>

    <h3>Scoring</h3>
    <ul>
      <li>The GOAT of each match is the player with the <strong>highest BPS</strong> (Bonus Points System) at full time</li>
      <li>BPS is calculated by the official FPL system based on match actions</li>
      <li>If your pick is the GOAT, you earn a <strong>GOAT point</strong></li>
      <li>Your total BPS across all picks is used as a tiebreaker</li>
    </ul>

    <h3>Standings</h3>
    <ul>
      <li>Players are ranked by <strong>total GOATs</strong> (correct picks)</li>
      <li>Tiebreaker: <strong>total BPS</strong> from all picks</li>
      <li>Use the GW switcher to view historical standings</li>
    </ul>

    <h3>BPS Explained</h3>
    <p>The Bonus Points System awards points based on match actions: goals, assists, clean sheets, key passes, tackles, saves, and more. It penalises for yellow/red cards, own goals, and fouls. Data is sourced from the official FPL API.</p>
  </div>
</div>

<!-- PROFILE PAGE -->
<div id="page-profile" class="page-overlay">
  <div class="page-header">
    <button class="page-back" onclick="closePage('profile')">&larr; Back</button>
    <div class="page-title">Profile</div>
  </div>
  <div class="profile-form">
    <label class="profile-label">Email</label>
    <input type="email" class="profile-input" id="profile-email" disabled>
    <label class="profile-label">Team Name</label>
    <input type="text" class="profile-input" id="profile-team-name" maxlength="30" placeholder="My Team">
    <button class="profile-save" onclick="saveProfile()">Save</button>
    <div class="profile-msg" id="profile-msg"></div>
  </div>
</div>

<!-- PLAYER PROFILE MODAL -->
<div id="mb-profile-overlay" onclick="if(event.target===this)closeProfile()">
  <div class="mb-profile-panel">
    <div class="mb-profile-close" onclick="closeProfile()">&#x2715;</div>
    <div id="mb-profile-content"><div class="mb-loading">Loading...</div></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://zanssnurnzdqwaxuadge.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbnNzbnVybnpkcXdheHVhZGdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjQ3MjYsImV4cCI6MjA4NzgwMDcyNn0.KfsLu5SEEjrWNeFxvYl3oanH4_I0LV6RwJxYErs6sQY';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CDN = 'https://zanssnurnzdqwaxuadge.supabase.co/storage/v1/object/public/player-photos/';
const SEASON = '25-26';
const PO = {GKP:1, DEF:2, MID:3, FWD:4};
const POS_COLORS = {GKP:'#f5c518', DEF:'#00d5e0', MID:'#a0e000', FWD:'#ff6b35'};
const FPL_TEAM_MAP = {"1":"ARS","2":"AVL","3":"BUR","4":"BOU","5":"BRE","6":"BHA","7":"CHE","8":"CRY","9":"EVE","10":"FUL","11":"LEE","12":"LIV","13":"MCI","14":"MUN","15":"NEW","16":"NFO","17":"SUN","18":"TOT","19":"WHU","20":"WOL"};

// ===== STATE =====
let currentUser = null;
const FIRST_GW = 28;
let activeGW = null;     // "real" current GW from gw_config
let viewGW = null;       // GW being viewed (nav switcher)
let gwConfigs = {};      // gw -> config cache
let gwLoading = false;   // prevent rapid switching race conditions
let fixtures = [];
let players = {};       // element_id -> player
let results = {};       // fixture_id -> [{element_id, bps, is_goat}]
let userPicks = {};     // fixture_id -> {element_id, id (pick uuid)}
let selections = {};    // fixture_id -> {element_id, code, name, img} (unsaved UI state)
let playerStats = {};   // element_id -> {avgRank, formRank, goats}

// ===== AUTH =====
async function initAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    showApp();
  }

  // Listen for auth changes (magic link callback)
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      showApp();
    }
    if (event === 'SIGNED_OUT') {
      currentUser = null;
      showAuth();
    }
  });
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const msg = document.getElementById('auth-msg');
  const btn = document.getElementById('auth-submit');
  if (!email) { msg.textContent = 'Enter your email'; msg.className = 'auth-msg error'; return; }

  btn.disabled = true;
  msg.textContent = 'Sending...';
  msg.className = 'auth-msg';

  const { error } = await sb.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.origin }
  });

  btn.disabled = false;
  if (error) {
    msg.textContent = error.message;
    msg.className = 'auth-msg error';
  } else {
    msg.textContent = 'Check your email for the magic link!';
    msg.className = 'auth-msg success';
  }
}

async function handleSignOut() {
  await sb.auth.signOut();
  closeMenu();
}

function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app-wrap').style.display = 'block';
  loadAppData();
}

function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app-wrap').style.display = 'none';
}

// ===== DATA LOADING =====
async function loadAppData() {
  // Load GW config (active)
  const { data: gwData } = await sb.from('gw_config').select('*').eq('is_active', true).limit(1).single();
  if (gwData) {
    activeGW = gwData.gw;
    viewGW = gwData.gw;
    gwConfigs[gwData.gw] = gwData;
  } else {
    document.getElementById('pick-gw-title').textContent = 'No active gameweek';
    return;
  }

  // Load players + stats once (they don't change per GW)
  await Promise.all([loadPlayers(), loadPlayerStats()]);
  loadProfileData();

  // Check URL hash for initial GW
  const hashGW = parseGWFromHash();
  if (hashGW && hashGW >= FIRST_GW && hashGW <= activeGW + 1) {
    viewGW = hashGW;
  }

  // Load GW-specific data
  await loadGWData(viewGW);
}

// ===== GW NAVIGATION =====
function changeViewGW(delta) {
  const newGW = viewGW + delta;
  if (newGW < FIRST_GW || newGW > activeGW + 1) return;
  loadGWData(newGW);
}

function updateGWNav() {
  document.getElementById('gw-nav-label').textContent = 'GW ' + viewGW;
  document.getElementById('gw-prev').disabled = (viewGW <= FIRST_GW);
  document.getElementById('gw-next').disabled = (viewGW >= activeGW + 1);
  // Update URL hash
  const newHash = '#gw' + viewGW + '_' + SEASON;
  if (window.location.hash !== newHash) {
    window.location.hash = newHash;
  }
}

function parseGWFromHash() {
  const hash = window.location.hash;
  if (!hash) return null;
  const m = hash.match(/^#gw(\d+)/i);
  if (m) return parseInt(m[1]);
  return null;
}

async function loadGWData(gw) {
  if (gwLoading) return;
  gwLoading = true;

  viewGW = gw;
  updateGWNav();

  try {
    // Cache gw_config if not cached
    if (!gwConfigs[gw]) {
      const { data: cfg } = await sb.from('gw_config').select('*').eq('gw', gw).limit(1).single();
      if (cfg) gwConfigs[gw] = cfg;
    }

    // Load fixtures + picks in parallel
    await Promise.all([loadFixtures(), loadUserPicks()]);
    await loadResults();

    // Render all tabs
    renderPickTab();
    renderLiveTab();
    renderMyTeam();
    loadStandings(viewGW);
    updateTabStates();
    autoSelectTab();
  } finally {
    gwLoading = false;
  }
}

function updateTabStates() {
  const pickBtn = document.getElementById('tab-btn-pick');
  const myteamBtn = document.getElementById('tab-btn-myteam');

  // Pick tab: locked if viewGW pick is locked
  if (isViewGWPickLocked()) {
    pickBtn.classList.add('locked');
    pickBtn.innerHTML = 'Pick Team <span class="lock-icon">&#x1F512;</span>';
  } else {
    pickBtn.classList.remove('locked');
    pickBtn.textContent = 'Pick Team';
  }

  // My Team tab: locked if no picks for viewGW
  const hasPicks = Object.keys(userPicks).length > 0;
  if (!hasPicks) {
    myteamBtn.classList.add('locked');
    myteamBtn.innerHTML = 'My Team <span class="lock-icon">&#x1F512;</span>';
  } else {
    myteamBtn.classList.remove('locked');
    myteamBtn.textContent = 'My Team';
  }
}

function isViewGWPickLocked() {
  // Past GW: always locked
  if (viewGW < activeGW) return true;
  // Future GW: not locked (viewable, but cards locked individually)
  if (viewGW > activeGW) return false;
  // Active GW: locked if submitted AND any match started/finished
  if (!fixtures.length) return false;
  const submitted = Object.keys(userPicks).length > 0;
  const anyStarted = fixtures.some(f => f.status !== 'scheduled' || new Date() >= new Date(f.kickoff_time));
  return submitted && anyStarted;
}

function autoSelectTab() {
  const hasPicks = Object.keys(userPicks).length > 0;
  const locked = isViewGWPickLocked();

  if (viewGW < activeGW) {
    // Past GW → Standings
    switchTab('standings');
  } else if (locked && hasPicks) {
    switchTab('myteam');
  } else if (locked && !hasPicks) {
    switchTab('live');
  } else {
    switchTab('pick');
  }
}

function goHome() {
  if (viewGW === activeGW) {
    // Already on active GW, just pick best tab
    autoSelectTab();
  } else {
    loadGWData(activeGW);
  }
}

async function loadFixtures() {
  const { data } = await sb.from('fixtures').select('*').eq('gw', viewGW).order('kickoff_time');
  fixtures = data || [];
}

async function loadPlayers() {
  const { data } = await sb.from('players').select('*');
  players = {};
  (data || []).forEach(p => { players[p.element_id] = p; });
}

async function loadResults() {
  if (!fixtures.length) return;
  const fixtureIds = fixtures.map(f => f.id);
  const { data } = await sb.from('results').select('*').in('fixture_id', fixtureIds).order('bps', { ascending: false });
  results = {};
  (data || []).forEach(r => {
    if (!results[r.fixture_id]) results[r.fixture_id] = [];
    results[r.fixture_id].push(r);
  });
}

async function loadUserPicks() {
  if (!currentUser || !viewGW) return;
  const { data } = await sb.from('picks').select('*').eq('user_id', currentUser.id).eq('gw', viewGW);
  userPicks = {};
  (data || []).forEach(p => { userPicks[p.fixture_id] = p; });

  // Sync to selections
  selections = {};
  for (const [fid, pick] of Object.entries(userPicks)) {
    const pl = players[pick.element_id];
    if (pl) {
      selections[parseInt(fid)] = {
        element_id: pick.element_id,
        code: pl.code,
        name: pl.short_name || pl.name,
        img: CDN + pl.code + '.png'
      };
    }
  }
}

async function loadPlayerStats() {
  // Fetch bps_rank for all players to compute Bayesian avg rank, form, GOAT count
  playerStats = {};
  let offset = 0;
  const allRows = [];
  while (true) {
    const { data } = await sb.from('player_history').select('element_id,bps_rank,round').order('round', { ascending: true }).range(offset, offset + 999);
    if (!data || !data.length) break;
    allRows.push(...data);
    offset += data.length;
    if (data.length < 1000) break;
  }
  // Bayesian average constants: C=6 prior games, M=15 mean rank
  const C = 6, M = 15;
  const byPlayer = {};
  for (const r of allRows) {
    if (!r.bps_rank) continue;
    if (!byPlayer[r.element_id]) byPlayer[r.element_id] = [];
    byPlayer[r.element_id].push(r.bps_rank);
  }
  for (const [eid, ranks] of Object.entries(byPlayer)) {
    const sum = ranks.reduce((s, r) => s + r, 0);
    const n = ranks.length;
    // Bayesian avg: pulls low-sample players toward mean
    const bayesAvg = (C * M + sum) / (C + n);
    const l6 = ranks.slice(-6);
    const l6sum = l6.reduce((s, r) => s + r, 0);
    const bayesForm = (C * M + l6sum) / (C + l6.length);
    const goats = ranks.filter(r => r === 1).length;
    playerStats[eid] = {
      avgRank: Math.round(bayesAvg * 10) / 10,
      formRank: Math.round(bayesForm * 10) / 10,
      goats, games: n
    };
  }
}

// ===== DEADLINE HELPERS =====
function getFirstKickoff() {
  // Returns kickoff of first SCHEDULED (not yet started) fixture
  if (!fixtures.length) return null;
  let earliest = null;
  for (const f of fixtures) {
    if (f.status !== 'scheduled') continue;
    const ko = new Date(f.kickoff_time);
    if (!earliest || ko < earliest) earliest = ko;
  }
  return earliest;
}

function hasSubmitted() {
  return Object.keys(userPicks).length > 0;
}

function isMatchLocked(f) {
  const now = new Date();
  const ko = new Date(f.kickoff_time);
  return f.status !== 'scheduled' || now >= ko;
}

// ===== PICK TAB =====
function renderPickTab() {
  const cfg = gwConfigs[viewGW];
  if (!cfg) return;
  document.getElementById('pick-gw-title').textContent = cfg.label || ('Gameweek ' + viewGW);

  // Show deadline = first kickoff time
  const firstKO = getFirstKickoff();
  const now = new Date();
  const submitted = hasSubmitted();
  let subText = '';

  if (!submitted) {
    if (!firstKO) {
      // All matches already started, no scheduled fixtures left
      subText = '\uD83D\uDD12 Deadline passed \u2014 all matches started';
    } else if (now >= firstKO) {
      subText = '\uD83D\uDD12 Deadline passed \u2014 picks are closed';
    } else {
      const koStr = firstKO.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' \u00B7 ' + firstKO.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
      subText = 'Submit before ' + koStr;
    }
  } else {
    subText = 'Submitted \u2713 \u2014 change picks until each match kicks off';
  }
  document.getElementById('pick-gw-sub').textContent = subText;

  renderMatchBlocks();
  renderStrip();
}

function renderMatchBlocks() {
  const container = document.getElementById('pick-matches');
  if (!fixtures.length) {
    container.innerHTML = '<div class="empty-state"><span class="emoji">&#x1F4C5;</span><h3>No fixtures</h3><p>Fixtures will appear when the gameweek is set up</p></div>';
    return;
  }

  const now = new Date();
  const firstKO = getFirstKickoff();
  const submitted = hasSubmitted();
  // Before submit: block if no scheduled fixtures left (global deadline passed)
  const globalDeadlinePassed = !submitted && (!firstKO || now >= firstKO);
  // Lock all matches if viewing non-active GW
  const notActiveGW = viewGW !== activeGW;

  let html = '';
  for (let idx = 0; idx < fixtures.length; idx++) {
    const f = fixtures[idx];
    const matchNum = idx + 1;
    const ko = new Date(f.kickoff_time);
    const matchStarted = isMatchLocked(f);
    // Always lock started matches. Before submit: also lock all if global deadline passed. Lock all for non-active GW.
    const locked = matchStarted || globalDeadlinePassed || notActiveGW;
    const sel = selections[f.id];

    // Get players for this fixture (both teams)
    const matchPlayers = getPlayersForFixture(f);

    const badgeHtml = sel ? '<span class="match-selected-badge">\u2713 ' + sel.name + '</span>' : '';
    const isFt = f.status === 'ft';
    const isLive = f.status === 'live';
    let lockedHtml = '';
    if (isFt) lockedHtml = '<span class="match-locked" style="color:#666">FT ' + f.home_score + '-' + f.away_score + '</span>';
    else if (isLive) lockedHtml = '<span class="match-locked">\u23F1 ' + f.minutes + "\u2019 " + f.home_score + '-' + f.away_score + '</span>';
    else if (locked) lockedHtml = '<span class="match-locked">\uD83D\uDD12 LOCKED</span>';
    const timeStr = ko.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' \u00B7 ' + ko.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

    const cards = matchPlayers.map(function(p, ci) {
      const isSel = sel && sel.element_id === p.element_id;
      const sc = isSel ? ' selected' : '';
      const ps = playerStats[p.element_id] || {};
      const avgR = ps.avgRank || 99;
      const formR = ps.formRank || 99;
      const goats = ps.goats || 0;
      return '<div class="phex-card' + sc + '" data-orig-idx="' + ci + '" data-pos="' + (p.position||'') + '" data-eid="' + p.element_id + '" data-code="' + p.code + '" data-name="' + esc(p.short_name || p.name) + '" data-team="' + (p.team_short||'') + '" data-ph="' + CDN + p.code + '.png" data-avgrank="' + avgR + '" data-form="' + formR + '" data-goats="' + goats + '">'
        + '<div class="phex-name-wrap">'
        + '<div class="phex-name" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">' + esc(p.short_name || p.name) + '</div>'
        + '<span class="phex-info-btn" onclick="event.stopPropagation();openProfileFromCard(this.closest(\'.phex-card\'))">i</span>'
        + '</div>'
        + '<div class="phex-outer' + sc + '" onclick="selectPlayer(' + f.id + ',' + p.element_id + ',this.closest(\'.phex-card\'),' + (locked?'true':'false') + ')">'
        + '<div class="phex-inner">'
        + '<img src="' + CDN + p.code + '.png" loading="' + (idx === 0 ? 'eager' : 'lazy') + '" onerror="this.style.display=\'none\'" alt="">'
        + '</div></div>'
        + '<div class="phex-team-pos">' + (p.team_short||'') + ' \u00B7 ' + p.position + '</div>'
        + '</div>';
    }).join('');

    html += '<div class="match-block" id="match-' + f.id + '">'
      + '<div class="match-header">'
      + '<div class="match-header-left">'
      + '<div class="match-num-hex">' + matchNum + '</div>'
      + '<div class="match-teams-wrap">'
      + '<div class="match-teams">' + f.home_short + ' <span>v</span> ' + f.away_short + '</div>'
      + '<div class="match-time">' + timeStr + '</div>'
      + '</div></div>'
      + '<div>' + badgeHtml + lockedHtml + '</div>'
      + '</div>'
      + '<div class="pos-tabs">'
      + '<div class="pos-tab active" onclick="sortMatch(' + f.id + ',\'all\',this)">All</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'avgrank\',this)">Avg Rank</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'form\',this)">Form</div>'
      + '<div class="pos-tab" onclick="sortMatch(' + f.id + ',\'goats\',this)">\uD83D\uDC51 GOAT</div>'
      + '</div>'
      + '<div class="player-row-outer"><div class="player-row">' + cards + '</div></div>'
      + '</div>';
  }

  container.innerHTML = html;
}

function getPlayersForFixture(f) {
  // Get all players for both teams in this fixture
  const all = Object.values(players).filter(p =>
    p.team_id === f.home_team_id || p.team_id === f.away_team_id
  );
  // Sort: home team first, then by position
  all.sort((a, b) => {
    const aHome = a.team_id === f.home_team_id ? 0 : 1;
    const bHome = b.team_id === f.home_team_id ? 0 : 1;
    if (aHome !== bHome) return aHome - bHome;
    return (PO[a.position]||5) - (PO[b.position]||5);
  });
  return all;
}

function selectPlayer(fixtureId, elementId, cardEl, locked) {
  if (viewGW !== activeGW) { showToast('Cannot pick for this gameweek'); return; }
  if (locked) { showToast('This match is locked'); return; }

  const matchBlock = document.getElementById('match-' + fixtureId);

  // Deselect all in this match
  matchBlock.querySelectorAll('.phex-card').forEach(c => {
    c.classList.remove('selected');
    c.querySelector('.phex-outer').classList.remove('selected');
  });

  // Select this card
  cardEl.classList.add('selected');
  cardEl.querySelector('.phex-outer').classList.add('selected');

  const name = cardEl.dataset.name;
  const code = parseInt(cardEl.dataset.code);
  const img = cardEl.dataset.ph;

  // Update badge
  const badge = matchBlock.querySelector('.match-header > div:last-child');
  badge.innerHTML = '<span class="match-selected-badge">\u2713 ' + name + '</span>';

  selections[fixtureId] = { element_id: elementId, code, name, img };
  renderStrip();

  // Auto-save if user already submitted picks (Phase 2)
  if (hasSubmitted()) {
    saveSinglePick(fixtureId, elementId);
  }
}

async function saveSinglePick(fixtureId, elementId) {
  if (!currentUser || viewGW !== activeGW) return;
  const existing = userPicks[fixtureId];
  try {
    if (existing) {
      if (existing.element_id === elementId) return; // no change
      await sb.from('picks').update({
        element_id: elementId,
        updated_at: new Date().toISOString()
      }).eq('id', existing.id);
    } else {
      await sb.from('picks').insert({
        user_id: currentUser.id,
        fixture_id: fixtureId,
        element_id: elementId,
        gw: viewGW
      });
    }
    // Update local state
    await loadUserPicks();
    showToast('Pick saved');
  } catch(e) {
    showToast('Error saving pick');
    console.error(e);
  }
}

function renderStrip() {
  const slotsEl = document.getElementById('strip-slots');
  const submitBtn = document.getElementById('strip-submit');
  const totalMatches = fixtures.length;
  let html = '';
  let count = 0;

  for (let i = 0; i < totalMatches; i++) {
    const fid = fixtures[i].id;
    const sel = selections[fid];
    if (sel) {
      count++;
      html += '<div class="strip-slot filled"><img src="' + sel.img + '" onerror="this.style.display=\'none\'" alt=""></div>';
    } else {
      html += '<div class="strip-slot"></div>';
    }
  }

  slotsEl.innerHTML = html;
  document.getElementById('strip-count').textContent = count + '/' + totalMatches;

  const submitted = hasSubmitted();
  const now = new Date();
  const firstKO = getFirstKickoff();
  const globalDeadlinePassed = !submitted && firstKO && now >= firstKO;

  if (submitted) {
    // Phase 2: auto-save mode, hide submit button
    submitBtn.style.display = 'none';
  } else if (globalDeadlinePassed) {
    submitBtn.textContent = 'Closed';
    submitBtn.disabled = true;
    submitBtn.style.display = '';
  } else if (count < totalMatches) {
    submitBtn.style.display = '';
    submitBtn.textContent = count === 0 ? 'Pick GOATs' : count + '/' + totalMatches + ' — pick all';
    submitBtn.disabled = true;
  } else {
    submitBtn.style.display = '';
    submitBtn.textContent = 'Submit';
    submitBtn.disabled = false;
  }
}

async function submitPicks() {
  if (!currentUser || viewGW !== activeGW) return;
  const btn = document.getElementById('strip-submit');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    for (const [fixtureId, sel] of Object.entries(selections)) {
      const fid = parseInt(fixtureId);
      const f = fixtures.find(x => x.id === fid);
      if (!f) continue;

      // Skip locked matches
      const now = new Date();
      const ko = new Date(f.kickoff_time);
      if (f.status !== 'scheduled' || now >= ko) continue;

      const existing = userPicks[fid];
      if (existing) {
        // Update existing pick
        if (existing.element_id !== sel.element_id) {
          await sb.from('picks').update({
            element_id: sel.element_id,
            updated_at: new Date().toISOString()
          }).eq('id', existing.id);
        }
      } else {
        // Insert new pick
        await sb.from('picks').insert({
          user_id: currentUser.id,
          fixture_id: fid,
          element_id: sel.element_id,
          gw: viewGW
        });
      }
    }

    // Reload picks
    await loadUserPicks();
    showToast('Picks saved!');
    // Re-render to switch to Phase 2 (auto-save mode)
    renderPickTab();
    renderMyTeam();
  } catch(e) {
    showToast('Error saving picks');
    console.error(e);
  }

  btn.disabled = false;
  btn.textContent = 'Submit';
}

function sortMatch(fixtureId, mode, tabEl) {
  const matchBlock = document.getElementById('match-' + fixtureId);
  matchBlock.querySelectorAll('.pos-tab').forEach(t => t.classList.remove('active'));
  tabEl.classList.add('active');
  const row = matchBlock.querySelector('.player-row');
  const cards = Array.from(row.querySelectorAll('.phex-card'));
  cards.forEach(c => c.classList.remove('hidden'));
  if (mode === 'all') {
    // Default: home team first, then by position
    cards.sort((a, b) => {
      const aIdx = parseInt(a.dataset.origIdx || '0');
      const bIdx = parseInt(b.dataset.origIdx || '0');
      return aIdx - bIdx;
    });
  } else if (mode === 'avgrank') {
    cards.sort((a, b) => parseFloat(a.dataset.avgrank) - parseFloat(b.dataset.avgrank));
  } else if (mode === 'form') {
    cards.sort((a, b) => parseFloat(a.dataset.form) - parseFloat(b.dataset.form));
  } else if (mode === 'goats') {
    cards.sort((a, b) => parseInt(b.dataset.goats) - parseInt(a.dataset.goats));
  }
  cards.forEach(c => row.appendChild(c));
}

// ===== LIVE TAB =====
async function renderLiveTab() {
  await Promise.all([loadFixtures(), loadResults()]);

  const nav = document.getElementById('live-nav');
  const content = document.getElementById('live-match-content');

  if (!fixtures.length) {
    nav.innerHTML = '';
    content.innerHTML = '<div class="empty-state"><span class="emoji">&#x26BD;</span><h3>No fixtures for GW' + viewGW + '</h3><p>Fixtures will appear when the gameweek is set up</p></div>';
    return;
  }

  // Build nav buttons
  let navHtml = '';
  let firstActive = null;
  for (const f of fixtures) {
    const isLive = f.status === 'live';
    const isFt = f.status === 'ft';
    const dotHtml = isLive ? '<span class="live-dot"></span>' : '';
    const statusHtml = isLive ? '<span class="live-nav-min">' + f.minutes + "'" + '</span>'
      : isFt ? '<span class="live-nav-ft">FT</span>'
      : '<span class="live-nav-time">' + new Date(f.kickoff_time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) + '</span>';

    const scoreHtml = (isLive || isFt) ? ' <span class="score">' + f.home_score + '\u2013' + f.away_score + '</span> ' : ' ';

    // Get user's pick rank in this match
    const myPick = userPicks[f.id];
    const matchResults = results[f.id] || [];
    let rankHtml = '';
    if (myPick && matchResults.length) {
      const idx = matchResults.findIndex(r => r.element_id === myPick.element_id);
      const rank = idx >= 0 ? idx + 1 : '–';
      const isGoat = idx === 0 && matchResults[0].is_goat;
      rankHtml = '<span class="lv-nav-rank' + (isGoat ? ' lv-rank-motm' : '') + '">' + rank + '</span>';
    }

    const cls = !firstActive && (isLive || isFt) ? ' active' : '';
    if (!firstActive && (isLive || isFt)) firstActive = f.id;
    navHtml += '<div class="live-match-btn' + cls + '" data-fid="' + f.id + '" onclick="showLiveMatch(' + f.id + ',this)">' + dotHtml + f.home_short + ' - ' + f.away_short + scoreHtml + statusHtml + rankHtml + '</div>';
  }

  // If no live/ft, select first fixture
  if (!firstActive && fixtures.length) firstActive = fixtures[0].id;
  if (!firstActive) return;

  nav.innerHTML = navHtml;
  // Ensure first active button is marked
  if (!nav.querySelector('.live-match-btn.active')) {
    var firstBtn = nav.querySelector('.live-match-btn[data-fid="' + firstActive + '"]');
    if (firstBtn) firstBtn.classList.add('active');
  }

  showLiveMatchContent(firstActive);
}

function showLiveMatch(fixtureId, btnEl) {
  document.querySelectorAll('.live-match-btn').forEach(b => b.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  showLiveMatchContent(fixtureId);
}

function showLiveMatchContent(fixtureId) {
  const content = document.getElementById('live-match-content');
  const f = fixtures.find(x => x.id === fixtureId);
  if (!f) return;

  const matchResults = results[fixtureId] || [];
  const isLive = f.status === 'live';
  const isFt = f.status === 'ft';
  const myPick = userPicks[fixtureId];

  // Header
  let html = '<div class="live-header">';
  html += '<div class="live-score-row">';
  html += '<div class="live-team-name">' + f.home_short + '</div>';
  if (isLive || isFt) {
    html += '<div class="live-score">' + f.home_score + ' \u2013 ' + f.away_score + '</div>';
  } else {
    html += '<div class="live-score">\u2013</div>';
  }
  html += '<div class="live-team-name">' + f.away_short + '</div>';
  html += '</div>';
  if (isLive) html += '<div style="text-align:center"><span class="live-minute">\u23F1 ' + f.minutes + "'" + '</span></div>';
  if (isFt) html += '<div style="text-align:center"><span style="color:#666;font-size:12px;font-weight:700">FULL TIME</span></div>';
  html += '</div>';

  // Player cards
  if (matchResults.length) {
    html += '<div class="live-strip-section"><div class="live-strip-wrap"><div class="live-strip">';
    matchResults.forEach((r, idx) => {
      const pl = players[r.element_id];
      if (!pl) return;
      const rank = idx + 1;
      const isGoat = r.is_goat;
      const isYours = myPick && myPick.element_id === r.element_id;
      let cls = 'lv-card';
      if (isGoat) cls += ' lv-motm';
      else if (isYours) cls += ' lv-yours';

      html += '<div class="' + cls + '">'
        + '<div class="lv-hex-wrap">'
        + '<div class="lv-hex-outer"><div class="lv-hex-inner"><img src="' + CDN + pl.code + '.png" onerror="this.style.display=\'none\'" alt=""></div></div>'
        + '<div class="lv-rank-badge">' + rank + '</div>'
        + '</div>'
        + '<div class="lv-name">' + esc(pl.short_name || pl.name) + '</div>'
        + '<div class="lv-pos">' + pl.position + '</div>'
        + '<div class="lv-bps">' + r.bps + '</div>'
        + '</div>';
    });
    html += '</div></div></div>';
  } else {
    html += '<div class="empty-state"><span class="emoji">&#x1F4CA;</span><h3>No BPS data yet</h3><p>BPS will update during the match</p></div>';
  }

  content.innerHTML = html;
}

// ===== MY TEAM TAB =====
function renderMyTeam() {
  const strip = document.getElementById('mt-strip');
  const cfg = gwConfigs[viewGW];
  document.getElementById('mt-subtitle').textContent = cfg ? (cfg.label || 'Gameweek ' + viewGW) : '';

  if (!Object.keys(userPicks).length) {
    strip.innerHTML = '<div class="empty-state" style="min-width:100vw"><span class="emoji">&#x1F90C;</span><h3>No picks yet</h3><p>Pick your GOATs on the Pick Team tab</p></div>';
    return;
  }

  // Sort picks: FT first, then live, then upcoming
  const sortedFixtures = [...fixtures].sort((a, b) => {
    const order = {ft: 0, live: 1, scheduled: 2};
    return (order[a.status]||2) - (order[b.status]||2);
  });

  let html = '';
  for (const f of sortedFixtures) {
    const pick = userPicks[f.id];
    if (!pick) continue;
    const pl = players[pick.element_id];
    if (!pl) continue;

    const isLive = f.status === 'live';
    const isFt = f.status === 'ft';
    const matchResults = results[f.id] || [];

    // Find rank (results are pre-sorted by bps desc)
    let rank = '–';
    let bpsVal = '–';
    let isGoat = false;
    if (matchResults.length) {
      const sorted = [...matchResults].sort((a, b) => b.bps - a.bps);
      const idx = sorted.findIndex(r => r.element_id === pick.element_id);
      if (idx >= 0) {
        rank = idx + 1;
        bpsVal = sorted[idx].bps;
        isGoat = sorted[idx].is_goat;
      }
    }

    const cardClass = isGoat ? ' motm' : '';
    const statusClass = isLive ? ' live' : '';
    let statusText = '';
    if (isFt) statusText = 'FT';
    else if (isLive) statusText = f.minutes + "'";
    else {
      const ko = new Date(f.kickoff_time);
      statusText = ko.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit'}) + ' \u00B7 ' + ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }

    const bpsClass = (!isLive && !isFt) ? ' pending' : '';
    const bpsDisplay = (!isLive && !isFt) ? '\u2013' : bpsVal;
    const canChange = !isMatchLocked(f);
    const changeBtn = canChange
      ? '<div class="mt2-change" onclick="goToMatch(' + f.id + ')">Change</div>'
      : '';

    html += '<div class="mt2-card' + cardClass + '">'
      + '<div class="mt2-match">' + f.home_short + ' - ' + f.away_short + '</div>'
      + '<div class="mt2-status' + statusClass + '">' + statusText + '</div>'
      + '<div class="mt2-hex-wrap">'
      + '<div class="mt2-hex-outer"><div class="mt2-hex-inner"><img src="' + CDN + pl.code + '.png" onerror="this.style.display=\'none\'" alt=""></div></div>'
      + '<div class="mt2-rank-badge">' + rank + '</div>'
      + '</div>'
      + '<div class="mt2-name">' + esc(pl.short_name || pl.name) + '</div>'
      + '<div class="mt2-pos">' + pl.position + '</div>'
      + '<div class="mt2-bps' + bpsClass + '">' + bpsDisplay + '</div>'
      + changeBtn
      + '</div>';
  }

  strip.innerHTML = html || '<div class="empty-state" style="min-width:100vw"><span class="emoji">&#x1F90C;</span><h3>No picks yet</h3></div>';
}

// ===== STANDINGS TAB =====
async function loadStandings(gw) {

  const content = document.getElementById('standings-content');
  content.innerHTML = '<div class="loading-spinner">Loading standings...</div>';

  // Get all picks for this GW
  const { data: allPicks } = await sb.from('picks').select('*').eq('gw', gw);
  if (!allPicks || !allPicks.length) {
    content.innerHTML = '<div class="empty-state"><span class="emoji">&#x1F3C6;</span><h3>No standings yet</h3><p>Standings appear after picks are submitted</p></div>';
    return;
  }

  // Get results for GW fixtures
  const { data: gwFixtures } = await sb.from('fixtures').select('*').eq('gw', gw);
  const fIds = (gwFixtures || []).map(f => f.id);
  const { data: gwResults } = await sb.from('results').select('*').in('fixture_id', fIds);

  // Build results lookup
  const resMap = {};
  (gwResults || []).forEach(r => {
    if (!resMap[r.fixture_id]) resMap[r.fixture_id] = {};
    resMap[r.fixture_id][r.element_id] = r;
  });

  // Calculate scores per user
  const userScores = {};
  allPicks.forEach(pick => {
    if (!userScores[pick.user_id]) userScores[pick.user_id] = { goats: 0, bps: 0, picks: [] };
    const r = resMap[pick.fixture_id] && resMap[pick.fixture_id][pick.element_id];
    const bps = r ? r.bps : 0;
    const isGoat = r ? r.is_goat : false;
    // Calculate rank from sorted results for this fixture
    let pickRank = 0;
    if (resMap[pick.fixture_id]) {
      const fResults = Object.values(resMap[pick.fixture_id]).sort((a, b) => b.bps - a.bps);
      const rIdx = fResults.findIndex(x => x.element_id === pick.element_id);
      if (rIdx >= 0) pickRank = rIdx + 1;
    }
    userScores[pick.user_id].bps += bps;
    if (isGoat) userScores[pick.user_id].goats++;
    userScores[pick.user_id].picks.push({ fixture_id: pick.fixture_id, element_id: pick.element_id, bps, isGoat, rank: pickRank });
  });

  // Get profiles
  const userIds = Object.keys(userScores);
  const { data: profiles } = await sb.from('profiles').select('*').in('id', userIds);
  const profileMap = {};
  (profiles || []).forEach(p => { profileMap[p.id] = p; });

  // Sort: GOATs desc, BPS desc
  const sorted = userIds.map(uid => ({
    uid,
    name: profileMap[uid] ? profileMap[uid].team_name : 'Unknown',
    goats: userScores[uid].goats,
    bps: userScores[uid].bps,
    picks: userScores[uid].picks
  })).sort((a, b) => b.goats - a.goats || b.bps - a.bps);

  // Find my position
  const myIdx = sorted.findIndex(s => s.uid === (currentUser ? currentUser.id : null));
  const myRank = myIdx >= 0 ? myIdx + 1 : '–';
  const myEntry = myIdx >= 0 ? sorted[myIdx] : null;

  // Build HTML
  let html = '<div class="lb-header">';
  html += '<div style="font-size:14px;font-weight:900;color:#fff">LEADERBOARD \u2014 GW' + gw + '</div>';
  html += '<div style="font-size:11px;color:#777;margin-top:4px">Ranked by: GOATs \u00B7 tiebreak: Total BPS &nbsp;\u00B7&nbsp; <span style="color:#BFB294;font-weight:700">' + sorted.length + ' managers</span></div>';
  html += '</div>';

  if (myEntry) {
    html += '<div class="lb-your-pos"><div>';
    html += '<div style="font-size:11px;color:#777;margin-bottom:2px">YOUR POSITION</div>';
    html += '<div class="lb-your-rank">#' + myRank + '</div>';
    html += '</div><div class="lb-your-info">' + esc(myEntry.name) + '<br><span>' + myEntry.goats + ' GOATs</span> \u00B7 <span>' + myEntry.bps.toLocaleString() + ' BPS</span></div></div>';
  }

  html += '<table class="lb-table"><thead><tr><th>#</th><th>Player</th><th style="text-align:center">GOATs</th><th style="text-align:right">BPS</th></tr></thead><tbody>';

  // Show top 20 + separator + my row
  const showCount = Math.min(20, sorted.length);
  for (let i = 0; i < showCount; i++) {
    const s = sorted[i];
    const rank = i + 1;
    const isMe = s.uid === (currentUser ? currentUser.id : null);
    const rankCls = rank <= 3 ? ' top3' : '';
    const nameCls = isMe ? ' me' : '';
    const rowCls = isMe ? ' class="my-row"' : '';
    html += '<tr' + rowCls + '><td class="lb-rank' + rankCls + '">' + rank + '</td><td class="lb-name' + nameCls + '"><span class="lb-name-btn" onclick="togglePicks(\'r' + i + '\')">' + esc(s.name) + '</span></td><td class="lb-motms">' + s.goats + '</td><td class="lb-pts">' + s.bps.toLocaleString() + '</td></tr>';
    html += buildPicksRow(i, s.picks, gwFixtures || []);
  }

  if (myIdx >= 20) {
    const gap = myIdx - showCount;
    html += '<tr class="separator"><td colspan="4">\u00B7 \u00B7 \u00B7 ' + gap + ' entries \u00B7 \u00B7 \u00B7</td></tr>';
    html += '<tr class="my-row"><td class="lb-rank">' + myRank + '</td><td class="lb-name me"><span class="lb-name-btn" onclick="togglePicks(\'rme\')">' + esc(myEntry.name) + '</span></td><td class="lb-motms">' + myEntry.goats + '</td><td class="lb-pts">' + myEntry.bps.toLocaleString() + '</td></tr>';
    html += buildPicksRow('me', myEntry.picks, gwFixtures || []);
  }

  html += '</tbody></table>';
  content.innerHTML = html;
}

function buildPicksRow(rowId, picks, gwFixtures) {
  let items = '';
  for (const p of picks) {
    const f = gwFixtures.find(x => x.id === p.fixture_id);
    const pl = players[p.element_id];
    if (!f || !pl) continue;

    const matchLabel = f.home_short + ' - ' + f.away_short;
    let stClass = '';
    let stText = '';
    if (f.status === 'ft') { stClass = ' ft'; stText = 'FT'; }
    else if (f.status === 'live') { stClass = ' live'; stText = f.minutes + "'"; }
    else {
      const ko = new Date(f.kickoff_time);
      stText = ko.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }

    const rankText = p.rank > 0 ? '#' + p.rank : '–';
    const bpsText = p.bps > 0 ? p.bps + ' BPS' : '';
    const goatMark = p.isGoat ? ' <span class="lb-pick-motm">\uD83D\uDC51</span>' : '';

    items += '<div class="lb-pick-item"><span class="lb-pick-match">' + matchLabel + '</span><span class="lb-pick-st' + stClass + '">' + stText + '</span><span class="lb-pick-player">' + esc(pl.short_name || pl.name) + ' (' + (pl.team_short||'') + ')</span><span class="lb-pick-rank">' + rankText + '</span><span style="color:#666;font-size:10px;margin-left:4px">' + bpsText + '</span>' + goatMark + '</div>';
  }
  return '<tr class="lb-picks-row" id="picks-r' + rowId + '" style="display:none"><td colspan="4"><div class="lb-picks-list">' + items + '</div></td></tr>';
}

// ===== PROFILE =====
async function loadProfileData() {
  if (!currentUser) return;
  document.getElementById('profile-email').value = currentUser.email || '';
  const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  if (data) {
    document.getElementById('profile-team-name').value = data.team_name || '';
  }
}

async function saveProfile() {
  const name = document.getElementById('profile-team-name').value.trim();
  if (!name) return;
  const { error } = await sb.from('profiles').update({ team_name: name, updated_at: new Date().toISOString() }).eq('id', currentUser.id);
  const msg = document.getElementById('profile-msg');
  if (error) { msg.textContent = 'Error: ' + error.message; msg.style.color = '#ff4444'; }
  else { msg.textContent = 'Saved!'; msg.style.color = '#4CAF50'; }
  setTimeout(() => { msg.textContent = ''; }, 3000);
}

// ===== PLAYER PROFILE MODAL =====
function openProfileFromCard(cardEl) {
  openProfile(
    parseInt(cardEl.dataset.eid),
    parseInt(cardEl.dataset.code),
    cardEl.dataset.name,
    cardEl.dataset.team,
    cardEl.dataset.pos,
    cardEl.dataset.ph
  );
}

async function openProfile(elementId, code, name, team, pos, ph) {
  const overlay = document.getElementById('mb-profile-overlay');
  const content = document.getElementById('mb-profile-content');
  overlay.style.display = 'flex';
  content.innerHTML = buildProfileHeader(name, team, pos, ph) + '<div class="mb-loading">Loading match history...</div>';

  try {
    // Try Supabase player_history first (fast, has bps_rank), fallback to FPL API
    const localData = await sb.from('player_history').select('*').eq('element_id', elementId).order('round', { ascending: true });

    let history;
    if (localData.data && localData.data.length > 0) {
      history = localData.data.map(r => ({
        fixture: r.fixture_id, round: r.round, opponent_team: r.opponent_team,
        was_home: r.was_home, kickoff_time: r.kickoff_time, minutes: r.minutes,
        bps: r.bps, total_points: r.total_points, goals_scored: r.goals_scored,
        assists: r.assists, clean_sheets: r.clean_sheets,
        yellow_cards: r.yellow_cards, red_cards: r.red_cards,
        bps_rank: r.bps_rank
      }));
    } else {
      const resp = await fetch('/api/player-detail?id=' + elementId);
      const data = await resp.json();
      if (!data.history) throw new Error('No history data');
      history = data.history;
    }

    content.innerHTML = buildProfileHeader(name, team, pos, ph)
      + buildProfileStats(history)
      + buildProfileHistory(history);
  } catch(e) {
    console.error('Profile load error:', e);
    content.innerHTML = buildProfileHeader(name, team, pos, ph)
      + buildProfileStatsMock()
      + '<div class="mb-api-note">\u26A0 Player data temporarily unavailable. Try again later.</div>';
  }
}

function closeProfile() { document.getElementById('mb-profile-overlay').style.display = 'none'; }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeProfile(); });

function buildProfileHeader(name, team, pos, ph) {
  var col = POS_COLORS[pos] || '#BFB294';
  return '<div class="mb-profile-header">'
    + '<div class="mb-profile-hex-outer"><div class="mb-profile-hex-inner">'
    + (ph ? '<img src="' + ph + '" onerror="this.style.display=\'none\'" alt="">' : '')
    + '</div></div>'
    + '<div style="flex:1">'
    + '<div class="mb-profile-name">' + esc(name) + '</div>'
    + '<div class="mb-profile-detail">'
    + '<span class="mb-pos-badge" style="background:' + col + '">' + pos + '</span>'
    + '<span>' + esc(team) + '</span>'
    + '</div></div></div>';
}

function buildProfileStats(history) {
  if (!history || !history.length) return buildProfileStatsMock();
  var played = history.filter(h => h.minutes > 0);
  var ranked = played.filter(h => h.bps_rank);
  var goatCount = ranked.filter(h => h.bps_rank === 1).length;
  var avgRank = ranked.length > 0 ? (ranked.reduce((s, h) => s + h.bps_rank, 0) / ranked.length).toFixed(1) : '-';
  var last6 = ranked.slice(-6);
  var formRank = last6.length > 0 ? (last6.reduce((s, h) => s + h.bps_rank, 0) / last6.length).toFixed(1) : '-';
  var totalBps = played.reduce((s, h) => s + (h.bps || 0), 0);
  return '<div class="mb-profile-stats">'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + goatCount + ' \uD83D\uDC51</div><div class="mb-stat-label">GOATs</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + avgRank + '</div><div class="mb-stat-label">Avg Rank</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + formRank + '</div><div class="mb-stat-label">Form (L6)</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">' + totalBps + '</div><div class="mb-stat-label">BPS Total</div></div>'
    + '</div>';
}

function buildProfileStatsMock() {
  return '<div class="mb-profile-stats">'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">BPS Total</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">Form</div></div>'
    + '<div class="mb-stat-block"><div class="mb-stat-val">\u2014</div><div class="mb-stat-label">Games</div></div>'
    + '</div>';
}

function buildProfileHistory(history) {
  if (!history || !history.length) {
    return '<div class="mb-history-title">Season History</div><p style="padding:20px;color:#555;text-align:center;font-size:12px">No match history available</p>';
  }
  // Build lookup by round
  var byRound = {};
  history.forEach(function(h) { byRound[h.round] = h; });
  // Find max round played this season
  var maxRound = Math.max.apply(null, history.map(function(h) { return h.round; }));
  var rows = '';
  // Show all GWs from most recent to GW1
  for (var gw = maxRound; gw >= 1; gw--) {
    var h = byRound[gw];
    if (h && h.minutes > 0) {
      var opp = FPL_TEAM_MAP[h.opponent_team] || '?';
      var ha = h.was_home ? '(H)' : '(A)';
      var bps = h.bps || 0;
      var rank = h.bps_rank;
      var rankHtml = '';
      if (rank === 1) rankHtml = ' <span style="color:#BFB294">\uD83D\uDC51</span>';
      else if (rank && rank <= 3) rankHtml = ' <span style="color:#8a8060;font-size:10px">(' + rank + ')</span>';
      else if (rank) rankHtml = ' <span style="color:#555;font-size:10px">(' + rank + ')</span>';
      var rowCls = rank === 1 ? ' class="goat-row"' : '';
      rows += '<tr' + rowCls + '><td>GW' + gw + '</td><td>' + opp + ' ' + ha + '</td><td>' + h.minutes + "'" + '</td><td class="td-bps">' + bps + rankHtml + '</td></tr>';
    } else {
      rows += '<tr style="opacity:0.35"><td>GW' + gw + '</td><td>\u2014</td><td>\u2014</td><td class="td-bps">\u2014</td></tr>';
    }
  }
  return '<div class="mb-history-title">Season History</div>'
    + '<div class="mb-history-wrap"><table class="mb-history-table">'
    + '<thead><tr><th>GW</th><th>Opp</th><th>Min</th><th>BPS / Rank</th></tr></thead>'
    + '<tbody>' + rows + '</tbody>'
    + '</table></div>';
}

// ===== NAVIGATION HELPERS =====
function goToMatch(fixtureId) {
  if (isViewGWPickLocked()) return;
  switchTab('pick');
  setTimeout(function() {
    var el = document.getElementById('match-' + fixtureId);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// ===== UI HELPERS =====
function switchTab(name) {
  // Prevent switching to locked pick tab
  if (name === 'pick' && isViewGWPickLocked()) return;
  // Prevent switching to My Team if no picks
  if (name === 'myteam' && Object.keys(userPicks).length === 0) return;

  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.getElementById('tab-btn-' + name).classList.add('active');

  // Show/hide team strip — only show on pick tab for active GW
  var strip = document.getElementById('team-strip');
  if (strip) strip.style.display = (name === 'pick' && viewGW === activeGW) ? '' : 'none';

  closeMenu();

  // Refresh data when switching tabs
  if (name === 'pick') { loadFixtures().then(() => { renderPickTab(); }); }
  if (name === 'live') renderLiveTab();
  if (name === 'myteam') { Promise.all([loadFixtures(), loadResults()]).then(() => renderMyTeam()); }
  if (name === 'standings') { loadStandings(viewGW); }
}

function togglePicks(rowId) {
  var row = document.getElementById('picks-' + rowId);
  if (!row) return;
  var isOpen = row.style.display !== 'none';
  document.querySelectorAll('.lb-picks-row').forEach(r => { r.style.display = 'none'; });
  if (!isOpen) row.style.display = '';
}

function toggleMenu() {
  document.getElementById('nav-dropdown').classList.toggle('open');
}

function closeMenu() {
  document.getElementById('nav-dropdown').classList.remove('open');
}

// Close menu on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.nav-right')) closeMenu();
});

function openPage(name) {
  document.getElementById('page-' + name).classList.add('open');
  closeMenu();
}

function closePage(name) {
  document.getElementById('page-' + name).classList.remove('open');
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== HASH ROUTING (browser back/forward) =====
window.addEventListener('hashchange', function() {
  if (!activeGW) return;
  const hashGW = parseGWFromHash();
  if (hashGW && hashGW >= FIRST_GW && hashGW <= activeGW + 1 && hashGW !== viewGW) {
    loadGWData(hashGW);
  }
});

// ===== AUTO-REFRESH (every 60s when on Live tab, only for active GW) =====
setInterval(function() {
  var liveTab = document.getElementById('tab-live');
  if (liveTab && liveTab.classList.contains('active') && viewGW === activeGW) {
    renderLiveTab();
  }
}, 60000);

// ===== INIT =====
// Handle email input enter key
document.getElementById('auth-email').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') handleAuth();
});

initAuth();
</script>
</body>
</html>
